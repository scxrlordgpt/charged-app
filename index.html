<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CHARGED">
<meta name="theme-color" content="#0a0a0a">
<title>CHARGED</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700;900&family=Barlow:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0a0a0a;--bg1:#111111;--bg2:#181818;--bg3:#222222;
    --border:#2a2a2a;--border-bright:#3a3a3a;
    --accent:#ffe600;--accent-dim:#3d3700;--accent-glow:rgba(255,230,0,0.15);
    --green:#22c55e;--green-dim:#14532d;
    --red:#ef4444;--red-dim:#7f1d1d;
    --text:#e8e8e8;--text-dim:#888;--text-faint:#444;
    --mono:'Share Tech Mono',monospace;
    --cond:'Barlow Condensed',sans-serif;
    --body:'Barlow',sans-serif;
    --safe-top:env(safe-area-inset-top,0px);
    --safe-bottom:env(safe-area-inset-bottom,0px);
  }
  *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
  html,body{background:var(--bg);color:var(--text);font-family:var(--body);height:100%;overflow:hidden;user-select:none;-webkit-user-select:none}
  body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:.4}

  #app{display:flex;flex-direction:column;height:100dvh}

  #topbar{padding:calc(var(--safe-top) + 12px) 16px 12px;background:var(--bg1);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;position:relative}
  #topbar::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:.5}
  .app-logo{font-family:var(--cond);font-weight:900;font-size:22px;letter-spacing:4px;color:var(--accent);text-transform:uppercase}
  .app-logo span{color:var(--text-dim);font-weight:300}
  #topbar-right{display:flex;gap:8px;align-items:center}
  .week-badge{font-family:var(--cond);font-size:11px;font-weight:700;letter-spacing:2px;padding:4px 10px;border-radius:2px;border:1px solid var(--accent);color:var(--accent);background:var(--accent-dim);text-transform:uppercase;cursor:pointer;white-space:nowrap}

  #nav{display:flex;border-bottom:1px solid var(--border);background:var(--bg1);flex-shrink:0}
  .nav-btn{flex:1;padding:10px 4px;border:none;background:none;color:var(--text-dim);font-family:var(--cond);font-weight:700;font-size:11px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;position:relative;transition:color .2s;display:flex;flex-direction:column;align-items:center;gap:3px}
  .nav-btn svg{width:18px;height:18px}
  .nav-btn.active{color:var(--accent)}
  .nav-btn.active::after{content:'';position:absolute;bottom:0;left:20%;right:20%;height:2px;background:var(--accent);box-shadow:0 0 8px var(--accent)}

  #pages{flex:1;overflow:hidden;position:relative}
  .page{position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;display:none;padding-bottom:calc(var(--safe-bottom) + 80px)}
  .page.active{display:block}
  .page::-webkit-scrollbar{width:2px}
  .page::-webkit-scrollbar-thumb{background:var(--border-bright);border-radius:1px}

  .card{background:var(--bg1);border:1px solid var(--border);border-radius:2px;margin:12px 12px 0;padding:14px;position:relative;overflow:hidden}
  .card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--border-bright),transparent)}
  .card-title{font-family:var(--cond);font-weight:700;font-size:11px;letter-spacing:3px;color:var(--text-dim);text-transform:uppercase;margin-bottom:12px;display:flex;align-items:center;gap:8px}
  .card-title .dot{width:5px;height:5px;border-radius:50%;background:var(--accent);box-shadow:0 0 6px var(--accent);flex-shrink:0}

  .section-header{font-family:var(--cond);font-weight:900;font-size:28px;letter-spacing:2px;text-transform:uppercase;padding:16px 16px 4px;color:var(--text);line-height:1}
  .section-sub{font-size:12px;color:var(--text-dim);font-weight:300;padding:0 16px 4px;letter-spacing:1px}

  .btn{border:none;cursor:pointer;font-family:var(--cond);font-weight:700;letter-spacing:2px;text-transform:uppercase;border-radius:2px;transition:all .15s;padding:10px 18px;font-size:13px}
  .btn-primary{background:var(--accent);color:#000;box-shadow:0 0 20px var(--accent-glow)}
  .btn-primary:active{transform:scale(.97);box-shadow:none}
  .btn-ghost{background:transparent;color:var(--text-dim);border:1px solid var(--border-bright)}
  .btn-ghost:active{background:var(--bg3)}
  .btn-sm{padding:6px 12px;font-size:11px}
  .btn-full{width:100%;display:block;text-align:center}
  .btn-icon{width:36px;height:36px;border-radius:2px;padding:0;display:flex;align-items:center;justify-content:center;background:var(--bg3);border:1px solid var(--border);color:var(--text-dim);cursor:pointer;flex-shrink:0}
  .btn-icon:active{background:var(--border)}

  .input-group{margin-bottom:12px}
  .input-label{font-family:var(--cond);font-size:10px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;margin-bottom:5px;display:block}
  input[type=text],input[type=number],select,textarea{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:2px;color:var(--text);font-family:var(--mono);font-size:14px;padding:9px 11px;outline:none;transition:border-color .15s;-webkit-appearance:none;appearance:none}
  input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow)}
  select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23888' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:30px}
  textarea{resize:vertical;min-height:60px;font-size:13px}
  input[type=range]{width:100%;-webkit-appearance:none;appearance:none;height:4px;background:var(--bg3);border-radius:2px;outline:none}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px var(--accent-glow);cursor:pointer}

  .tag{display:inline-block;font-family:var(--cond);font-size:10px;letter-spacing:1.5px;text-transform:uppercase;padding:3px 8px;border-radius:2px;font-weight:700}
  .tag-green{background:var(--green-dim);color:var(--green)}
  .tag-orange{background:var(--accent-dim);color:var(--accent)}
  .tag-red{background:var(--red-dim);color:var(--red)}
  .tag-gray{background:var(--bg3);color:var(--text-dim)}

  .stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .stat-block{background:var(--bg2);border:1px solid var(--border);border-radius:2px;padding:10px 12px}
  .stat-label{font-family:var(--cond);font-size:9px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;margin-bottom:3px}
  .stat-value{font-family:var(--mono);font-size:20px;color:var(--text)}
  .stat-value.accent{color:var(--accent)}
  .stat-sub{font-size:10px;color:var(--text-dim);font-family:var(--mono);margin-top:2px}

  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:flex-end;z-index:1000;opacity:0;pointer-events:none;transition:opacity .2s}
  .modal-overlay.open{opacity:1;pointer-events:all}
  .modal{background:var(--bg1);border-top:1px solid var(--border);border-left:1px solid var(--border);border-right:1px solid var(--border);border-radius:4px 4px 0 0;width:100%;max-height:92dvh;overflow-y:auto;padding:20px 16px calc(var(--safe-bottom) + 20px);transform:translateY(100%);transition:transform .3s cubic-bezier(.32,.72,0,1)}
  .modal-overlay.open .modal{transform:translateY(0)}
  .modal-handle{width:36px;height:4px;background:var(--border-bright);border-radius:2px;margin:0 auto 20px;display:block}
  .modal-title{font-family:var(--cond);font-weight:900;font-size:22px;letter-spacing:2px;text-transform:uppercase;margin-bottom:16px;color:var(--accent)}

  .fb-banner{border-radius:2px;padding:12px 14px;margin:12px 12px 0;display:none;border-left:3px solid;animation:slideDown .3s ease}
  @keyframes slideDown{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
  .fb-banner.show{display:block}
  .fb-banner.good{background:var(--green-dim);border-color:var(--green)}
  .fb-banner.warn{background:#1c1a00;border-color:#a07700}
  .fb-banner.drop{background:var(--red-dim);border-color:var(--red)}
  .fb-banner.up{background:var(--accent-dim);border-color:var(--accent)}
  .fb-title{font-family:var(--cond);font-weight:700;font-size:13px;letter-spacing:2px;text-transform:uppercase;margin-bottom:4px}
  .fb-body{font-size:13px;color:var(--text-dim);line-height:1.4}

  .set-row{display:flex;align-items:center;gap:8px;padding:10px 0;border-bottom:1px solid var(--border);animation:fadeIn .2s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateX(-4px)}to{opacity:1;transform:none}}
  .set-row:last-child{border-bottom:none}
  .set-num{font-family:var(--mono);font-size:11px;color:var(--text-faint);width:20px;flex-shrink:0}
  .set-data{flex:1;display:flex;gap:5px;flex-wrap:wrap}
  .chip{font-family:var(--mono);font-size:12px;padding:3px 7px;background:var(--bg2);border:1px solid var(--border);border-radius:2px;color:var(--text-dim)}
  .chip.pr{border-color:var(--accent);color:var(--accent);background:var(--accent-glow)}
  .rpe-chip{font-family:var(--mono);font-size:12px;padding:3px 7px;border-radius:2px;border:1px solid}
  .rpe-lo{color:var(--green);border-color:var(--green);background:var(--green-dim)}
  .rpe-md{color:#a07700;border-color:#a07700;background:#1c1a00}
  .rpe-hi{color:var(--accent);border-color:var(--accent-dim);background:var(--accent-glow)}
  .rpe-mx{color:var(--red);border-color:var(--red-dim);background:var(--red-dim)}

  .ex-item{padding:11px 0;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:10px}
  .ex-item:last-child{border-bottom:none}
  .ex-name{font-weight:500;font-size:15px}
  .ex-meta{font-family:var(--cond);font-size:11px;color:var(--text-dim);letter-spacing:1px;margin-top:2px}

  /* DAY + WEEK SELECTORS */
  .pills{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px}
  .pill{font-family:var(--cond);font-weight:700;font-size:11px;letter-spacing:1.5px;padding:5px 9px;border-radius:2px;cursor:pointer;text-transform:uppercase;border:1px solid var(--border);background:var(--bg2);color:var(--text-dim);transition:all .15s}
  .pill.active{background:var(--accent);color:#000;border-color:var(--accent);box-shadow:0 0 10px var(--accent-glow)}
  .pill.has-data{border-color:var(--border-bright);color:var(--text)}
  /* week pills use blue tones to differentiate from day pills */
  .wpill{font-family:var(--cond);font-weight:700;font-size:11px;letter-spacing:1.5px;padding:5px 12px;border-radius:2px;cursor:pointer;text-transform:uppercase;border:1px solid var(--border);background:var(--bg2);color:var(--text-dim);transition:all .15s;position:relative}
  .wpill.active{background:var(--accent);color:#000;border-color:var(--accent);box-shadow:0 0 10px var(--accent-glow)}
  .wpill.has-data{border-color:var(--border-bright);color:var(--text)}
  .wpill.current-wk::after{content:'NOW';position:absolute;top:-7px;right:2px;font-size:7px;letter-spacing:1px;color:var(--accent);font-family:var(--cond)}

  /* REST TIMER */
  #rest-timer{position:fixed;bottom:calc(var(--safe-bottom) + 70px);left:12px;right:12px;background:var(--bg2);border:1px solid var(--accent);border-radius:2px;padding:10px 14px;display:none;align-items:center;gap:12px;z-index:500;box-shadow:0 0 20px var(--accent-glow);animation:slideUp .3s ease}
  @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:none;opacity:1}}
  #rest-timer.show{display:flex}
  #rest-bar{height:3px;background:var(--bg3);border-radius:1px;margin-top:4px}
  #rest-fill{height:100%;background:var(--accent);border-radius:1px;transition:width 1s linear;box-shadow:0 0 6px var(--accent)}
  .timer-wrap{flex:1}

  .muscle-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .muscle-name{font-family:var(--cond);font-size:12px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;width:90px;flex-shrink:0}
  .muscle-bar-bg{flex:1;height:8px;background:var(--bg3);border-radius:1px;overflow:hidden}
  .muscle-bar{height:100%;border-radius:1px;transition:width .5s cubic-bezier(.34,1.56,.64,1)}
  .muscle-sets{font-family:var(--mono);font-size:11px;width:30px;text-align:right;flex-shrink:0}

  .divider-lbl{display:flex;align-items:center;gap:8px;margin:12px 0;font-family:var(--cond);font-size:10px;letter-spacing:2px;color:var(--text-faint);text-transform:uppercase}
  .divider-lbl::before,.divider-lbl::after{content:'';flex:1;height:1px;background:var(--border)}

  .pr-badge{display:inline-flex;align-items:center;gap:4px;font-family:var(--cond);font-size:10px;font-weight:700;letter-spacing:1px;padding:2px 7px;border-radius:2px;background:var(--accent-glow);border:1px solid var(--accent);color:var(--accent)}

  .empty{text-align:center;padding:32px 16px;color:var(--text-faint)}
  .empty-icon{font-size:28px;margin-bottom:10px;opacity:.4}
  .empty-text{font-family:var(--cond);font-size:13px;letter-spacing:2px;text-transform:uppercase}
  .empty-sub{font-size:12px;margin-top:5px}

  .prog-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
  .prog-btn{padding:13px 8px;border:1px solid var(--border);background:var(--bg2);border-radius:2px;text-align:center;cursor:pointer;transition:all .15s}
  .prog-btn.sel{border-color:var(--accent);background:var(--accent-dim)}
  .prog-btn .pi{font-size:22px;margin-bottom:5px}
  .prog-btn .pl{font-family:var(--cond);font-weight:700;font-size:12px;letter-spacing:1px;text-transform:uppercase;color:var(--text)}
  .prog-btn.sel .pl{color:var(--accent)}
  .prog-btn .ps{font-size:11px;color:var(--text-dim);margin-top:2px}

  .flex-bet{display:flex;justify-content:space-between;align-items:center}
  .gap8{gap:8px}.mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mb8{margin-bottom:8px}
  .text-acc{color:var(--accent)}.text-dim{color:var(--text-dim)}.mono{font-family:var(--mono)}
  canvas{width:100%!important}
  @keyframes popIn{0%{transform:scale(0);opacity:0}60%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}
  .pop{animation:popIn .3s cubic-bezier(.34,1.56,.64,1)}
</style>
</head>
<body>
<div id="app">
  <div id="topbar">
    <div class="app-logo">CHAR<span>GED</span></div>
    <div id="topbar-right">
      <div id="wk-timer" class="mono" style="font-size:14px;color:var(--text-dim);display:none"></div>
      <div id="week-badge-wrap"></div>
      <button class="btn-icon" onclick="openModal('settings-modal')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </button>
    </div>
  </div>

  <div id="nav">
    <button class="nav-btn active" onclick="showPage('today')" id="nav-today">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>Today
    </button>
    <button class="nav-btn" onclick="showPage('plan')" id="nav-plan">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Plan
    </button>
    <button class="nav-btn" onclick="showPage('history')" id="nav-history">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>Progress
    </button>
    <button class="nav-btn" onclick="showPage('volume')" id="nav-volume">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="6" height="18"/><rect x="9" y="8" width="6" height="13"/><rect x="16" y="13" width="6" height="8"/></svg>Volume
    </button>
  </div>

  <div id="pages">
    <div class="page active" id="page-today"><div id="today-content"></div></div>
    <div class="page" id="page-plan"><div id="plan-content"></div></div>
    <div class="page" id="page-history">
      <div class="section-header">Progress</div>
      <div class="section-sub">1RM estimates & personal records</div>
      <div id="history-content"></div>
    </div>
    <div class="page" id="page-volume">
      <div class="section-header">Weekly Volume</div>
      <div class="section-sub">Sets per muscle group this week</div>
      <div id="volume-content"></div>
    </div>
  </div>

  <!-- REST TIMER -->
  <div id="rest-timer">
    <div class="timer-wrap">
      <div class="flex-bet mb8">
        <div>
          <div id="rest-lbl" style="font-family:var(--cond);font-size:10px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase">Rest</div>
          <div id="rest-rsn" style="font-size:10px;color:var(--text-faint);font-family:var(--cond);letter-spacing:1px;margin-top:1px"></div>
        </div>
        <div id="rest-count" style="font-family:var(--mono);font-size:28px;color:var(--accent)">1:30</div>
      </div>
      <div id="rest-bar"><div id="rest-fill" style="width:100%"></div></div>
    </div>
    <button class="btn-icon" onclick="stopRest()" style="flex-shrink:0">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="log-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="log-title">Log Set</div>
    <div id="log-body"></div>
  </div>
</div>

<div class="modal-overlay" id="add-ex-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="add-ex-title">Add Exercise</div>
    <div class="input-group"><label class="input-label">Exercise Name</label><input type="text" id="ex-name" placeholder="e.g. Bench Press"></div>
    <div class="input-group"><label class="input-label">Muscle Group</label>
      <select id="ex-muscle">
        <option>Chest</option><option>Back</option><option>Shoulders</option>
        <option>Biceps</option><option>Triceps</option><option>Legs</option>
        <option>Glutes</option><option>Core</option><option>Calves</option>
      </select>
    </div>
    <div style="display:flex;gap:8px">
      <div class="input-group" style="flex:1"><label class="input-label">Sets</label><input type="number" id="ex-sets" value="4" min="1" max="10"></div>
      <div class="input-group" style="flex:1"><label class="input-label">Rep Range</label>
        <select id="ex-rr">
          <option value="1-3">1‚Äì3 Max Strength</option>
          <option value="4-6">4‚Äì6 Strength</option>
          <option value="6-8">6‚Äì8 Str-Hyp</option>
          <option value="8-12" selected>8‚Äì12 Hypertrophy</option>
          <option value="12-15">12‚Äì15 Hyp-End</option>
          <option value="15-20">15‚Äì20 Endurance</option>
        </select>
      </div>
    </div>
    <div class="input-group"><label class="input-label">Starting Weight (kg)</label><input type="number" id="ex-weight" placeholder="60" step="0.5"></div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeModal('add-ex-modal')">Cancel</button>
      <button class="btn btn-primary" style="flex:1" onclick="saveExercise()">Add</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="advance-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="advance-title">Advance Week</div>
    <div id="advance-body"></div>
  </div>
</div>

<div class="modal-overlay" id="settings-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Settings</div>
    <div style="font-family:var(--cond);font-size:10px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;margin-bottom:10px">Program Structure</div>
    <div class="prog-grid">
      <div class="prog-btn sel" id="pt-weekly" onclick="setProgType('weekly')">
        <div class="pi">üîÅ</div><div class="pl">Weekly</div><div class="ps">Same exercises every week</div>
      </div>
      <div class="prog-btn" id="pt-block" onclick="setProgType('block')">
        <div class="pi">üìÖ</div><div class="pl">Block</div><div class="ps">Different exercises each week</div>
      </div>
    </div>
    <div id="bl-row" style="display:none" class="input-group">
      <label class="input-label">Block Length (weeks)</label>
      <select id="s-bl"><option value="3">3 weeks</option><option value="4" selected>4 weeks</option><option value="5">5 weeks</option><option value="6">6 weeks</option></select>
    </div>
    <div class="divider-lbl">Rest Timers</div>
    <div class="input-group">
      <label class="input-label">Rest Time Multiplier</label>
      <select id="s-rest">
        <option value="0.75">0.75x ‚Äî Shorter</option>
        <option value="1.0" selected>1.0x ‚Äî Default (evidence-based)</option>
        <option value="1.25">1.25x ‚Äî Slightly longer</option>
        <option value="1.5">1.5x ‚Äî Longer</option>
        <option value="2.0">2.0x ‚Äî Max</option>
      </select>
      <div style="margin-top:5px;font-family:var(--cond);font-size:10px;color:var(--text-faint);letter-spacing:1px;line-height:1.6">1‚Äì3 reps: 4 min ¬∑ 4‚Äì6: 3 min ¬∑ 6‚Äì8: 2:30<br>8‚Äì12: 1:30 ¬∑ 12‚Äì15: 1 min ¬∑ 15‚Äì20: 40s</div>
    </div>
    <div class="divider-lbl">Overload Rules</div>
    <div style="display:flex;gap:8px">
      <div class="input-group" style="flex:1"><label class="input-label">Drop % (too hard)</label><input type="number" id="s-drop" value="10" min="5" max="25"></div>
      <div class="input-group" style="flex:1"><label class="input-label">Increase % (too easy)</label><input type="number" id="s-inc" value="5" min="2" max="15"></div>
    </div>
    <button class="btn btn-primary btn-full mt16" onclick="saveSettings();closeModal('settings-modal')">Save</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];

const RPE_TARGETS = {'1-3':9.5,'4-6':8.75,'6-8':8.25,'8-12':7.75,'12-15':7.25,'15-20':6.75};

const REST_CFG = {
  '1-3': {base:240,label:'Max Strength',reason:'CNS & neural recovery'},
  '4-6': {base:180,label:'Strength',reason:'Heavy load recovery'},
  '6-8': {base:150,label:'Str-Hyp',reason:'Balanced recovery'},
  '8-12':{base:90, label:'Hypertrophy',reason:'Metabolic stress window'},
  '12-15':{base:60,label:'Hyp-Endurance',reason:'Keep lactate elevated'},
  '15-20':{base:40,label:'Endurance',reason:'Minimal rest, sustained effort'},
};

// % of estimated 1RM for a given rep count
const PCT_1RM = {1:1.00,2:0.97,3:0.94,4:0.91,5:0.88,6:0.85,7:0.83,8:0.80,9:0.77,10:0.75,11:0.72,12:0.70,13:0.68,14:0.66,15:0.65,16:0.63,17:0.62,18:0.61,19:0.60,20:0.58};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Plan structure (block mode):
//   plan[day][week] = [ {id, name, muscle, sets, repRange, baseWeight}, ... ]
// Plan structure (weekly mode):
//   plan[day][1]   = [ exercises ]   (week key is always "1")
//
// Sessions:
//   { date, day, week, exercises: [ {exerciseId, name, sets:[...]} ] }

let S = {
  prog: {type:'weekly', blockLen:4, curWeek:1, cycleCount:1},
  plan: {},        // plan[day][weekNum] = [exercise]
  sessions: [],
  settings: {restMult:1.0, dropPct:10, incPct:5},
  planDay: 'Monday',
  planWeek: 1,
  session: null,
  wkTimerInterval: null,
  restInterval: null,
  wkStart: null,
};

function load() {
  try {
    const d = JSON.parse(localStorage.getItem('charged-v3')||'{}');
    if (d.prog)     S.prog     = {...S.prog,     ...d.prog};
    if (d.plan)     S.plan     = d.plan;
    if (d.sessions) S.sessions = d.sessions;
    if (d.settings) S.settings = {...S.settings, ...d.settings};
    S.planWeek = S.prog.curWeek;
  } catch(e){}
}

function save() {
  localStorage.setItem('charged-v3', JSON.stringify({
    prog:S.prog, plan:S.plan, sessions:S.sessions, settings:S.settings
  }));
}

load();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const isBlock  = () => S.prog.type === 'block';
const curWeek  = () => S.prog.curWeek;
const blockLen = () => S.prog.blockLen || 4;
const planKey  = (day, wk) => { const w = isBlock() ? wk : 1; return (S.plan[day] || {})[w] || []; };

// Get exercises for today's session (current week)
const todayExercises = (day) => planKey(day, curWeek());

// All unique exercise names ever used (for 1RM lookup across name)
function allExerciseSessions(exId) {
  const sets = [];
  for (const s of S.sessions)
    for (const ex of s.exercises)
      if (ex.exerciseId === exId)
        sets.push(...ex.sets);
  return sets;
}

const epley   = (w, r) => r === 1 ? w : Math.round(w * (1 + r/30) * 10) / 10;
const roundW  = w => Math.round(w * 2) / 2;
const fmtT    = s => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
const rpeClass= r => r<=6?'rpe-lo':r<=7.5?'rpe-md':r<=8.5?'rpe-hi':'rpe-mx';

function best1RM(exId) {
  let best = 0;
  for (const s of allExerciseSessions(exId)) {
    const e = epley(s.weight, s.reps); if (e > best) best = e;
  }
  return best;
}

function weightFrom1RM(oneRM, repRange) {
  if (!oneRM) return null;
  const lo = parseInt(repRange.split('-')[0]);
  return roundW(oneRM * (PCT_1RM[lo] || 0.75));
}

function getRestConf(rr) {
  const c = REST_CFG[rr];
  if (!c) return {secs:90,label:'Rest',reason:''};
  return {secs: Math.round(c.base * (S.settings.restMult||1)), label:c.label, reason:c.reason};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERLOAD ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function feedback(ex, setData) {
  const target = RPE_TARGETS[ex.repRange] || 7.5;
  const diff   = setData.rpe - target;
  const [lo, hi] = ex.repRange.split('-').map(Number);
  const drop = S.settings.dropPct / 100;
  const inc  = S.settings.incPct  / 100;

  if (diff >= 2)  { const nw=roundW(setData.weight*(1-drop)); return {type:'drop',title:'üîª Too Heavy',   msg:`RPE ${setData.rpe} vs target ${target}. Drop to ${nw}kg, reset to ${lo} reps.`,  sugg:{weight:nw,reps:lo}}; }
  if (diff >= 1)  return {type:'warn',title:'‚ö†Ô∏è Slightly Over', msg:`RPE ${setData.rpe} vs target ${target}. Try slowing eccentric +1s.`,                                                      sugg:null};
  if (diff <= -2) { const nw=roundW(setData.weight*(1+inc));  return {type:'up',  title:'‚¨ÜÔ∏è Too Easy',    msg:`RPE ${setData.rpe} vs target ${target}. Increase to ${nw}kg next set.`,           sugg:{weight:nw,reps:setData.reps}}; }
  if (diff <= -1) return {type:'up',  title:'‚ûï Room to Grow', msg:`RPE ${setData.rpe} vs target ${target}. Add 1 rep next set.`,                                                              sugg:null};
  if (setData.reps >= hi && Math.abs(diff)<=0.5) {
    const nw=roundW(setData.weight*(1+inc));
    return {type:'good',title:'üèÜ Progress!',  msg:`Hit top of rep range at target RPE. Next session: ${nw}kg.`, sugg:{weight:nw,reps:lo}};
  }
  return {type:'good',title:'‚úÖ On Target', msg:`RPE ${setData.rpe} matches target ${target}. Keep this weight.`, sugg:null};
}

function nextSuggestion(ex) {
  const [lo] = ex.repRange.split('-').map(Number);

  // Look for last session that included this exact exercise id
  for (const s of [...S.sessions].reverse()) {
    const se = s.exercises.find(e => e.exerciseId === ex.id);
    if (se && se.sets.length) {
      const last = se.sets[se.sets.length-1];
      const fb = feedback(ex, last);
      if (fb.sugg) return {...fb.sugg, est:false};
      return {weight:last.weight, reps:last.reps, est:false};
    }
  }

  // No history for this exact exercise ‚Äî estimate from 1RM
  const oneRM = best1RM(ex.id);
  if (oneRM > 0) {
    const w = weightFrom1RM(oneRM, ex.repRange);
    if (w) return {weight:w, reps:lo, est:true, oneRM};
  }

  return {weight: ex.baseWeight||20, reps:lo, est:false};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id)  { document.getElementById(id).classList.add('open');    document.body.style.overflow='hidden'; }
function closeModal(id) { document.getElementById(id).classList.remove('open'); document.body.style.overflow=''; }
document.querySelectorAll('.modal-overlay').forEach(el => el.addEventListener('click', e => { if(e.target===el) closeModal(el.id); }));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPage(name) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  document.getElementById('nav-'+name).classList.add('active');
  ({today:renderToday, plan:renderPlan, history:renderHistory, volume:renderVolume})[name]?.();
}

function updateBadge() {
  const el = document.getElementById('week-badge-wrap');
  if (!isBlock()) { el.innerHTML=''; return; }
  el.innerHTML = `<div class="week-badge" onclick="openAdvanceModal()">W${curWeek()}/${blockLen()}</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TODAY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function todayName() { return ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][new Date().getDay()]; }

function renderToday() {
  const day  = todayName();
  const exs  = todayExercises(day);
  const ses  = S.session?.day === day ? S.session : null;
  const el   = document.getElementById('today-content');

  const wTag = isBlock() ? ` <span class="tag tag-orange" style="font-size:9px;vertical-align:middle">WEEK ${curWeek()}</span>` : '';
  let html = `<div class="section-header">${day}${wTag}</div>`;

  if (!exs.length) {
    html += `<div class="section-sub">Rest day ‚Äî no exercises scheduled</div>
      <div class="card"><div class="empty"><div class="empty-icon">üõå</div>
        <div class="empty-text">Rest & Recover</div>
        <div class="empty-sub">Add exercises for ${day}${isBlock()?` Week ${curWeek()}`:''} in Plan.</div>
      </div></div>`;
    el.innerHTML = html; return;
  }

  if (!ses) {
    // Pre-workout preview
    html += `<div class="card"><div class="flex-bet">
      <div>
        <div style="font-family:var(--cond);font-weight:700;font-size:16px;letter-spacing:1px">Ready to train?</div>
        <div style="color:var(--text-dim);font-size:13px;margin-top:4px">${exs.map(e=>e.name).join(' ¬∑ ')}</div>
      </div>
      <button class="btn btn-primary" onclick="startWorkout('${day}')">Start</button>
    </div></div>
    <div class="card"><div class="card-title"><div class="dot"></div>Today's Plan</div>`;

    for (const ex of exs) {
      const sg  = nextSuggestion(ex);
      const pr  = best1RM(ex.id);
      html += `<div class="ex-item" style="cursor:default">
        <div style="flex:1">
          <div class="ex-name">${ex.name}</div>
          <div class="ex-meta">${ex.sets} sets ¬∑ ${ex.repRange} reps ¬∑ <span class="text-acc">${sg.weight}kg${sg.est?' <span style="color:var(--text-faint);font-size:10px">(est.)</span>':''}</span></div>
          ${pr>0?`<div style="margin-top:5px"><span class="pr-badge">üèÜ 1RM~${pr}kg</span></div>`:''}
        </div>
        <div class="tag tag-gray">${ex.muscle}</div>
      </div>`;
    }
    html += `</div>`;
  } else {
    // Active workout
    html += `<div id="fb-area"></div>`;
    for (const ex of exs) {
      const se     = ses.exercises.find(e=>e.exerciseId===ex.id);
      const logged = se ? se.sets : [];
      const [lo]   = ex.repRange.split('-').map(Number);
      let sg;
      if (logged.length) {
        const fb = feedback(ex, logged[logged.length-1]);
        sg = fb.sugg || {weight:logged[logged.length-1].weight, reps:logged[logged.length-1].reps};
      } else { sg = nextSuggestion(ex); }

      html += `<div class="card">
        <div class="flex-bet mb8">
          <div>
            <div style="font-family:var(--cond);font-weight:900;font-size:18px;letter-spacing:1px;text-transform:uppercase">${ex.name}</div>
            <div class="ex-meta">${ex.sets} sets ¬∑ ${ex.repRange} reps ¬∑ <span class="text-acc">Target ${sg.weight}kg √ó ${sg.reps||lo}${sg.est?' <span style="color:var(--text-faint);font-size:10px">(est.)</span>':''}</span></div>
          </div>
          <div class="tag tag-gray">${ex.muscle}</div>
        </div>
        <div id="sets-${ex.id}">`;

      logged.forEach((s,i) => {
        const est = epley(s.weight, s.reps);
        const pr  = best1RM(ex.id);
        html += `<div class="set-row">
          <div class="set-num">${i+1}</div>
          <div class="set-data">
            <span class="chip">${s.weight}kg</span>
            <span class="chip">${s.reps} reps</span>
            <span class="rpe-chip ${rpeClass(s.rpe)}">RPE ${s.rpe}</span>
            ${s.tempo&&s.tempo!=='0-0-0-0'?`<span class="chip">${s.tempo}</span>`:''}
            ${est>=pr&&est>0?`<span class="chip pr pop">üèÜ PR</span>`:''}
            <span class="chip" style="color:var(--text-faint);font-size:11px">1RM~${est}kg</span>
          </div>
        </div>`;
      });
      html += `</div>`;

      if (ex.sets - logged.length > 0) {
        html += `<button class="btn btn-primary btn-full mt8" onclick="openLogSet('${ex.id}','${day}')">+ Log Set ${logged.length+1} / ${ex.sets}</button>`;
      } else {
        html += `<div class="tag tag-green mt8 pop" style="display:inline-block">‚úì Complete</div>`;
      }
      html += `</div>`;
    }
    html += `<div class="card"><button class="btn btn-ghost btn-full" onclick="finishWorkout()">Finish Workout</button></div>`;
  }

  el.innerHTML = html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORKOUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startWorkout(day) {
  const exs = todayExercises(day);
  S.session = {
    date: new Date().toISOString().split('T')[0], day, week:curWeek(),
    exercises: exs.map(ex => ({exerciseId:ex.id, name:ex.name, sets:[]}))
  };
  S.wkStart = Date.now();
  const tw = document.getElementById('wk-timer');
  tw.style.display = 'block';
  S.wkTimerInterval = setInterval(() => {
    const e = Math.floor((Date.now()-S.wkStart)/1000);
    tw.textContent = `${Math.floor(e/60).toString().padStart(2,'0')}:${(e%60).toString().padStart(2,'0')}`;
  }, 1000);
  renderToday();
}

function finishWorkout() {
  if (!S.session) return;
  S.sessions.push({...S.session});
  S.session = null;
  clearInterval(S.wkTimerInterval);
  document.getElementById('wk-timer').style.display = 'none';
  save(); renderToday();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOG SET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let logCtx = null;

function openLogSet(exId, day) {
  const exs = todayExercises(day);
  const ex  = exs.find(e=>e.id===exId);
  if (!ex) return;
  const se   = S.session.exercises.find(e=>e.exerciseId===exId);
  const prev = se ? se.sets : [];
  const sNum = prev.length + 1;
  const [lo] = ex.repRange.split('-').map(Number);
  const tRPE = RPE_TARGETS[ex.repRange] || 7.5;

  let sg;
  if (prev.length) {
    const fb = feedback(ex, prev[prev.length-1]);
    sg = fb.sugg || {weight:prev[prev.length-1].weight, reps:prev[prev.length-1].reps};
  } else { sg = nextSuggestion(ex); }

  logCtx = {exId, day, ex};
  document.getElementById('log-title').textContent = `${ex.name} ‚Äî Set ${sNum}`;
  const oneRM = best1RM(exId);
  const estNote = sg.est && oneRM>0
    ? `<div style="font-size:11px;color:var(--text-faint);margin-top:2px;font-family:var(--cond);letter-spacing:1px">From 1RM ${oneRM}kg ¬∑ ${Math.round(sg.weight/oneRM*100)}% of max</div>` : '';

  document.getElementById('log-body').innerHTML = `
    <div style="background:var(--bg2);border:1px solid var(--border);border-radius:2px;padding:10px 12px;margin-bottom:16px">
      <div style="font-family:var(--cond);font-size:10px;letter-spacing:2px;color:var(--text-dim);margin-bottom:4px;text-transform:uppercase">Target This Set</div>
      <div style="font-family:var(--mono);font-size:22px;color:var(--accent)">${sg.weight}kg √ó ${sg.reps||lo}</div>
      <div style="font-size:12px;color:var(--text-dim);margin-top:2px">Target RPE: ${tRPE} ¬∑ ${ex.repRange} reps${isBlock()?` ¬∑ Week ${curWeek()}`:''}</div>
      ${estNote}
    </div>
    <div style="display:flex;gap:8px">
      <div class="input-group" style="flex:1"><label class="input-label">Weight (kg)</label><input type="number" id="lw" value="${sg.weight}" step="0.5" min="0"></div>
      <div class="input-group" style="flex:1"><label class="input-label">Reps</label><input type="number" id="lr" value="${sg.reps||lo}" min="1" max="50"></div>
    </div>
    <div class="input-group">
      <label class="input-label">RPE / Difficulty ‚Äî <span id="rpe-val" class="text-acc">${tRPE}</span> / 10</label>
      <input type="range" id="lrpe" min="1" max="10" step="0.5" value="${tRPE}" oninput="document.getElementById('rpe-val').textContent=this.value">
    </div>
    <div class="input-group">
      <label class="input-label">Tempo (ecc ‚Äì bot ‚Äì con ‚Äì top)</label>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px">
        ${['Ecc','Bot','Con','Top'].map((l,i)=>`<div>
          <div style="font-family:var(--cond);font-size:9px;color:var(--text-faint);text-align:center;margin-bottom:3px;text-transform:uppercase;letter-spacing:1px">${l}</div>
          <input type="number" id="t${i+1}" value="${i===0?3:i===2?1:0}" min="0" max="10" style="text-align:center;padding:8px 4px">
        </div>`).join('')}
      </div>
    </div>
    <div class="input-group"><label class="input-label">Notes (optional)</label><textarea id="ln" placeholder="Form cues, how it felt..."></textarea></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeModal('log-modal')">Cancel</button>
      <button class="btn btn-primary" style="flex:1" onclick="saveSet()">Log Set</button>
    </div>`;
  openModal('log-modal');
}

function saveSet() {
  if (!logCtx) return;
  const weight = parseFloat(document.getElementById('lw').value)||0;
  const reps   = parseInt(document.getElementById('lr').value)||0;
  const rpe    = parseFloat(document.getElementById('lrpe').value)||7;
  const tempo  = `${document.getElementById('t1').value}-${document.getElementById('t2').value}-${document.getElementById('t3').value}-${document.getElementById('t4').value}`;
  const notes  = document.getElementById('ln').value;

  const se = S.session.exercises.find(e=>e.exerciseId===logCtx.exId);
  if (se) se.sets.push({weight,reps,rpe,tempo,notes,est1rm:epley(weight,reps)});

  closeModal('log-modal');

  const fb = feedback(logCtx.ex, {weight,reps,rpe});
  const fbEl = document.getElementById('fb-area');
  if (fbEl) {
    fbEl.innerHTML = `<div class="fb-banner show ${fb.type}">
      <div class="fb-title">${fb.title}</div>
      <div class="fb-body">${fb.msg}</div>
    </div>`;
    setTimeout(()=>{ const b=fbEl.querySelector('.fb-banner'); if(b) b.style.opacity='.4'; }, 6000);
  }

  const rc = getRestConf(logCtx.ex.repRange);
  startRest(rc.secs, rc.label, rc.reason);
  renderToday();
  setTimeout(()=>document.getElementById('fb-area')?.scrollIntoView({behavior:'smooth',block:'start'}), 100);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REST TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startRest(secs, label, reason) {
  stopRest();
  let rem = secs;
  document.getElementById('rest-lbl').textContent  = label ? `Rest ¬∑ ${label}` : 'Rest';
  document.getElementById('rest-rsn').textContent  = reason || '';
  document.getElementById('rest-count').textContent = fmtT(rem);
  document.getElementById('rest-fill').style.width  = '100%';
  document.getElementById('rest-timer').classList.add('show');
  S.restInterval = setInterval(()=>{
    rem--;
    document.getElementById('rest-count').textContent = fmtT(rem);
    document.getElementById('rest-fill').style.width  = (rem/secs*100)+'%';
    if (rem<=0) stopRest();
  }, 1000);
}

function stopRest() {
  clearInterval(S.restInterval);
  document.getElementById('rest-timer').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAN PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Plan structure: S.plan[day][week] = [exercises]
// Weekly mode:   S.plan[day][1]    = [exercises]  (always week 1)
// Block mode:    S.plan[day][1..N] = [exercises per week]

function renderPlan() {
  const el = document.getElementById('plan-content');
  const bl = blockLen(), wk = S.planWeek || 1;

  let html = `<div class="section-header">Training Plan</div>`;

  if (isBlock()) {
    // Week selector row
    html += `<div style="padding:8px 12px 0">
      <div style="font-family:var(--cond);font-size:10px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;margin-bottom:6px">Editing Week</div>
      <div class="pills" id="plan-wpills">`;
    for (let w=1; w<=bl; w++) {
      const isCur = w === curWeek();
      const hasDat = DAYS.some(d => ((S.plan[d]||{})[w]||[]).length > 0);
      html += `<div class="wpill ${w===wk?'active':''} ${isCur?'current-wk':''} ${hasDat?'has-data':''}" onclick="setPlanWeek(${w})">
        W${w}${isCur?' ‚ö°':''}
      </div>`;
    }
    html += `</div>
      <div style="font-size:12px;color:var(--text-dim);font-family:var(--cond);letter-spacing:1px;margin-top:4px;padding-bottom:4px">
        Currently training: <span style="color:var(--accent)">Week ${curWeek()}</span> ¬∑ 
        <span style="color:var(--accent);cursor:pointer" onclick="openAdvanceModal()">Advance week ‚Üí</span>
      </div>
    </div>`;
  }

  html += `<div class="card">
    <div class="card-title"><div class="dot"></div>Select Day${isBlock()?` ‚Äî Week ${wk}`:''}</div>
    <div class="pills" id="plan-dpills"></div>
    <div id="plan-day-content"></div>
  </div>`;

  el.innerHTML = html;

  // Day pills
  document.getElementById('plan-dpills').innerHTML = DAYS.map(d => {
    const w = isBlock() ? wk : 1;
    const has = ((S.plan[d]||{})[w]||[]).length > 0;
    const act = S.planDay === d;
    return `<div class="pill ${act?'active':''} ${has?'has-data':''}" onclick="setPlanDay('${d}')">${d.slice(0,3)}</div>`;
  }).join('');

  renderPlanDayContent();
}

function setPlanDay(day)  { S.planDay  = day;  renderPlan(); }
function setPlanWeek(wk)  { S.planWeek = wk;   renderPlan(); }

function renderPlanDayContent() {
  const day = S.planDay;
  const wk  = isBlock() ? (S.planWeek||1) : 1;
  const exs = ((S.plan[day]||{})[wk]) || [];
  const el  = document.getElementById('plan-day-content');
  let html  = '';

  if (!exs.length) {
    html = `<div class="empty" style="padding:18px 0">
      <div class="empty-text">No exercises${isBlock()?` for Week ${wk}`:''}</div>
    </div>`;
  } else {
    exs.forEach((ex, i) => {
      html += `<div class="ex-item">
        <div style="flex:1">
          <div class="ex-name">${ex.name}</div>
          <div class="ex-meta">${ex.sets} sets ¬∑ ${ex.repRange} reps ¬∑ ${ex.baseWeight}kg base ¬∑ <span class="text-acc">${ex.muscle}</span></div>
        </div>
        <button class="btn-icon" onclick="removeExercise('${day}',${wk},${i})" style="color:var(--red)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/></svg>
        </button>
      </div>`;
    });
  }
  html += `<button class="btn btn-ghost btn-full mt8" onclick="openAddEx()">+ Add Exercise</button>`;
  el.innerHTML = html;
}

function openAddEx() {
  document.getElementById('ex-name').value   = '';
  document.getElementById('ex-weight').value = '';
  const wk = isBlock() ? (S.planWeek||1) : 1;
  document.getElementById('add-ex-title').textContent = isBlock()
    ? `Add Exercise ‚Äî Week ${wk}, ${S.planDay}` : `Add Exercise ‚Äî ${S.planDay}`;
  openModal('add-ex-modal');
}

function saveExercise() {
  const name = document.getElementById('ex-name').value.trim();
  if (!name) { alert('Please enter a name'); return; }
  const muscle  = document.getElementById('ex-muscle').value;
  const sets    = parseInt(document.getElementById('ex-sets').value)||4;
  const rr      = document.getElementById('ex-rr').value;
  const baseW   = parseFloat(document.getElementById('ex-weight').value)||20;
  const day     = S.planDay;
  const wk      = isBlock() ? (S.planWeek||1) : 1;

  if (!S.plan[day]) S.plan[day] = {};
  if (!S.plan[day][wk]) S.plan[day][wk] = [];

  S.plan[day][wk].push({
    id: Date.now().toString(), name, muscle, sets, repRange:rr, baseWeight:baseW
  });
  save(); closeModal('add-ex-modal'); renderPlan();
}

function removeExercise(day, wk, idx) {
  S.plan[day][wk].splice(idx, 1);
  save(); renderPlan();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEEK ADVANCE & CYCLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAdvanceModal() {
  const wk = curWeek(), bl = blockLen(), isLast = wk >= bl;
  document.getElementById('advance-title').textContent = isLast ? '‚ö° Complete Block' : `Advance to Week ${wk+1}`;

  // Gather all exercises scheduled in next week (or W1 of new cycle)
  const nextWk = isLast ? 1 : wk + 1;
  let html = '';

  if (isLast) {
    html += `<p style="font-size:14px;color:var(--text-dim);margin-bottom:16px;line-height:1.6">
      You've completed <strong style="color:var(--text)">Week ${bl} of ${bl}</strong> ‚Äî full block done (Cycle ${S.prog.cycleCount}).
      Starting Cycle ${S.prog.cycleCount+1}: the app will use your 1RM estimates to suggest Week 1 starting weights.
    </p>`;

    // Show Week 1 exercises with estimated weights for new cycle
    html += `<div style="font-family:var(--cond);font-size:10px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;margin-bottom:8px">Cycle ${S.prog.cycleCount+1} ‚Äî Week 1 Preview</div>`;
    for (const day of DAYS) {
      const exs = ((S.plan[day]||{})[1]) || [];
      if (!exs.length) continue;
      html += `<div style="font-family:var(--cond);font-size:10px;color:var(--text-faint);letter-spacing:1px;margin:8px 0 4px;text-transform:uppercase">${day}</div>`;
      for (const ex of exs) {
        const oneRM = best1RM(ex.id);
        const estW  = oneRM > 0 ? weightFrom1RM(oneRM, ex.repRange) : null;
        html += `<div class="flex-bet" style="padding:6px 0;border-bottom:1px solid var(--border)">
          <div><div style="font-size:14px">${ex.name}</div>
               <div class="ex-meta">${ex.repRange} reps</div></div>
          <div style="text-align:right">
            <div style="font-family:var(--mono);font-size:15px;color:var(--accent)">${estW?estW+'kg':ex.baseWeight+'kg'}</div>
            ${oneRM>0?`<div style="font-family:var(--cond);font-size:10px;color:var(--text-faint)">1RM~${oneRM}kg</div>`:''}
          </div>
        </div>`;
      }
    }
    html += `<button class="btn btn-primary btn-full mt16" onclick="startNewCycle();closeModal('advance-modal')">Start Cycle ${S.prog.cycleCount+1}</button>`;
  } else {
    html += `<p style="font-size:14px;color:var(--text-dim);margin-bottom:16px;line-height:1.6">
      Moving from <strong style="color:var(--text)">Week ${wk}</strong> to <strong style="color:var(--accent)">Week ${wk+1}</strong>. 
      Each day will show the exercises you set up for Week ${wk+1}.
    </p>`;

    // Preview week N+1 schedule
    let anyNext = false;
    for (const day of DAYS) {
      const thisExs = ((S.plan[day]||{})[wk])    || [];
      const nextExs = ((S.plan[day]||{})[wk+1])  || [];
      if (!thisExs.length && !nextExs.length) continue;
      anyNext = true;
      html += `<div style="font-family:var(--cond);font-size:10px;color:var(--text-faint);letter-spacing:1px;margin:8px 0 4px;text-transform:uppercase">${day}</div>`;

      if (!nextExs.length) {
        html += `<div style="font-size:13px;color:var(--text-faint);padding:4px 0;border-bottom:1px solid var(--border)">Rest day (no exercises set for W${wk+1})</div>`;
      } else {
        for (const ex of nextExs) {
          const oneRM = best1RM(ex.id);
          const sg    = nextSuggestion(ex);
          html += `<div class="flex-bet" style="padding:6px 0;border-bottom:1px solid var(--border)">
            <div><div style="font-size:14px">${ex.name}</div>
                 <div class="ex-meta">${ex.repRange} reps ¬∑ ${ex.sets} sets</div></div>
            <div style="text-align:right">
              <div style="font-family:var(--mono);font-size:15px;color:var(--accent)">${sg.weight}kg${sg.est?' <span style="font-size:10px;color:var(--text-faint)">(est.)</span>':''}</div>
              ${oneRM>0?`<div style="font-family:var(--cond);font-size:10px;color:var(--text-faint)">1RM~${oneRM}kg</div>`:''}
            </div>
          </div>`;
        }
      }
    }
    if (!anyNext) html += `<div style="font-size:13px;color:var(--text-faint)">No exercises set up for Week ${wk+1} yet. Add them in Plan ‚Üí Week ${wk+1}.</div>`;
    html += `<button class="btn btn-primary btn-full mt16" onclick="advanceWeek();closeModal('advance-modal')">Advance to Week ${wk+1}</button>`;
  }

  document.getElementById('advance-body').innerHTML = html;
  openModal('advance-modal');
}

function advanceWeek() {
  S.prog.curWeek++;
  S.planWeek = S.prog.curWeek;
  save(); updateBadge(); renderToday(); renderPlan();
}

function startNewCycle() {
  S.prog.curWeek    = 1;
  S.planWeek        = 1;
  S.prog.cycleCount = (S.prog.cycleCount||1) + 1;
  save(); updateBadge(); renderToday(); renderPlan();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHistory() {
  const el = document.getElementById('history-content');
  // Gather all unique exercises across all weeks
  const allEx = {};
  for (const day of DAYS)
    for (const wk of Object.keys(S.plan[day]||{}))
      for (const ex of (S.plan[day][wk]||[]))
        allEx[ex.id] = ex;

  if (!Object.keys(allEx).length) {
    el.innerHTML = `<div class="card"><div class="empty"><div class="empty-text">No exercises in plan yet</div></div></div>`;
    return;
  }

  let html = '';
  for (const [id, ex] of Object.entries(allEx)) {
    const hist = [];
    for (const s of S.sessions)
      for (const se of s.exercises)
        if (se.exerciseId===id && se.sets.length)
          hist.push({date:s.date, best:Math.max(...se.sets.map(st=>epley(st.weight,st.reps))), week:s.week||1});

    const pr = hist.length ? Math.max(...hist.map(h=>h.best)) : 0;
    const sg = nextSuggestion(ex);

    html += `<div class="card">
      <div class="flex-bet mb8">
        <div>
          <div style="font-family:var(--cond);font-weight:900;font-size:17px;letter-spacing:1px;text-transform:uppercase">${ex.name}</div>
          <div class="ex-meta">${ex.repRange} reps ¬∑ ${ex.muscle}</div>
        </div>
        ${pr>0?`<span class="pr-badge">üèÜ ${pr}kg</span>`:'<span class="tag tag-gray">No data</span>'}
      </div>
      <div class="stat-grid">
        <div class="stat-block"><div class="stat-label">Est. 1RM PR</div><div class="stat-value accent">${pr>0?pr+'kg':'‚Äî'}</div></div>
        <div class="stat-block">
          <div class="stat-label">Next Target</div>
          <div class="stat-value">${sg.weight}kg</div>
          <div class="stat-sub">${sg.reps||'‚Äî'} reps${sg.est?' (est.)':''}</div>
        </div>
      </div>
      ${hist.length>=2?renderSparkline(hist):''}
    </div>`;
  }
  el.innerHTML = html;
}

function renderSparkline(hist) {
  const sid = 'sp-'+Math.random().toString(36).slice(2,8);
  setTimeout(()=>{
    const c = document.getElementById(sid); if(!c) return;
    const ctx=c.getContext('2d');
    const W=c.offsetWidth*devicePixelRatio, H=70*devicePixelRatio;
    c.width=W; c.height=H;
    const vals=hist.map(h=>h.best), mn=Math.min(...vals)*.95, mx=Math.max(...vals)*1.02;
    const sx=W/(vals.length-1||1), sy=H/(mx-mn||1);
    ctx.strokeStyle='#ffe600'; ctx.lineWidth=2*devicePixelRatio; ctx.lineJoin='round';
    ctx.shadowBlur=8*devicePixelRatio; ctx.shadowColor='#ffe600';
    ctx.beginPath();
    vals.forEach((v,i)=>{ const x=i*sx,y=H-(v-mn)*sy; i===0?ctx.moveTo(x,y):ctx.lineTo(x,y); });
    ctx.stroke();
    ctx.shadowBlur=0;
    ctx.lineTo((vals.length-1)*sx,H); ctx.lineTo(0,H); ctx.closePath();
    const g=ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'rgba(255,230,0,.25)'); g.addColorStop(1,'rgba(255,230,0,0)');
    ctx.fillStyle=g; ctx.fill();
    ctx.shadowBlur=6*devicePixelRatio; ctx.shadowColor='#ffe600'; ctx.fillStyle='#ffe600';
    vals.forEach((v,i)=>{ ctx.beginPath(); ctx.arc(i*sx,H-(v-mn)*sy,3*devicePixelRatio,0,Math.PI*2); ctx.fill(); });
  },50);
  return `<div style="margin-top:12px">
    <div style="font-family:var(--cond);font-size:9px;letter-spacing:2px;color:var(--text-faint);text-transform:uppercase;margin-bottom:4px">Est. 1RM Progress</div>
    <canvas id="${sid}" style="width:100%;height:70px;display:block"></canvas>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VOLUME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderVolume() {
  const el = document.getElementById('volume-content');
  const now = new Date(), dow = now.getDay()||7;
  const ws = new Date(now); ws.setDate(now.getDate()-dow+1); ws.setHours(0,0,0,0);
  const muscles={}, thisWeek=S.sessions.filter(s=>new Date(s.date)>=ws);
  let tSets=0, tReps=0;

  for (const s of thisWeek) {
    for (const ex of s.exercises) {
      let m='Other';
      for (const d of DAYS)
        for (const wk of Object.keys(S.plan[d]||{})) {
          const px=(S.plan[d][wk]||[]).find(p=>p.id===ex.exerciseId);
          if (px) { m=px.muscle; break; }
        }
      muscles[m]=(muscles[m]||0)+ex.sets.length;
      tSets+=ex.sets.length;
      tReps+=ex.sets.reduce((a,s)=>a+s.reps,0);
    }
  }

  if (!Object.keys(muscles).length) {
    el.innerHTML=`<div class="card"><div class="empty"><div class="empty-icon">üìä</div><div class="empty-text">No sessions this week yet</div></div></div>`;
    return;
  }

  const rec={Chest:12,Back:14,Shoulders:12,Biceps:10,Triceps:10,Legs:14,Glutes:12,Core:10,Calves:10};
  let html=`<div class="card"><div class="card-title"><div class="dot"></div>This Week</div>
    <div class="stat-grid mb8">
      <div class="stat-block"><div class="stat-label">Total Sets</div><div class="stat-value accent">${tSets}</div></div>
      <div class="stat-block"><div class="stat-label">Total Reps</div><div class="stat-value">${tReps}</div></div>
    </div><div class="divider-lbl">Muscle Volume</div>`;

  for (const [m,sets] of Object.entries(muscles).sort((a,b)=>b[1]-a[1])) {
    const r=rec[m]||12, p=Math.min(sets/r*100,100);
    const col=sets>=r?'var(--green)':sets>=r*.6?'var(--accent)':'var(--red)';
    html+=`<div class="muscle-row">
      <div class="muscle-name">${m}</div>
      <div class="muscle-bar-bg"><div class="muscle-bar" style="width:${p}%;background:${col};box-shadow:0 0 8px ${col}40"></div></div>
      <div class="muscle-sets" style="color:${col}">${sets}</div>
    </div>`;
  }
  html+=`<div style="font-size:11px;color:var(--text-faint);margin-top:8px;font-family:var(--cond);letter-spacing:1px">Green = on track with recommended weekly volume.</div></div>`;

  html+=`<div class="card"><div class="card-title"><div class="dot"></div>Sessions This Week</div>`;
  for (const s of [...thisWeek].reverse())
    html+=`<div class="ex-item" style="cursor:default">
      <div style="flex:1">
        <div class="ex-name">${s.day}${s.week?` <span class="tag tag-orange" style="font-size:9px">W${s.week}</span>`:''}</div>
        <div class="ex-meta">${s.date} ¬∑ ${s.exercises.length} exercises ¬∑ ${s.exercises.reduce((a,e)=>a+e.sets.length,0)} sets</div>
      </div></div>`;
  html+=`</div>`;
  el.innerHTML=html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setProgType(type) {
  S.prog.type = type;
  document.getElementById('pt-weekly').classList.toggle('sel', type==='weekly');
  document.getElementById('pt-block').classList.toggle('sel',  type==='block');
  document.getElementById('bl-row').style.display = type==='block'?'block':'none';
}

function saveSettings() {
  S.settings.restMult = parseFloat(document.getElementById('s-rest').value)||1.0;
  S.settings.dropPct  = parseInt(document.getElementById('s-drop').value)||10;
  S.settings.incPct   = parseInt(document.getElementById('s-inc').value)||5;
  S.prog.blockLen     = parseInt(document.getElementById('s-bl').value)||4;
  save(); updateBadge();
}

// Init settings UI from saved state
document.getElementById('s-rest').value = S.settings.restMult||1.0;
document.getElementById('s-drop').value = S.settings.dropPct;
document.getElementById('s-inc').value  = S.settings.incPct;
document.getElementById('s-bl').value   = S.prog.blockLen||4;
setProgType(S.prog.type||'weekly');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
S.planWeek = S.prog.curWeek || 1;
updateBadge();
renderToday();
renderPlan();
</script>
</body>
</html>
