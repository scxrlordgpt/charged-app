<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CHARGED">
<meta name="theme-color" content="#0a0a0a">
<title>CHARGED</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700;900&family=Barlow:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0a0a0a;--bg1:#111111;--bg2:#181818;--bg3:#222222;
    --border:#2a2a2a;--border-bright:#3a3a3a;
    --accent:#ffe600;--accent-dim:#3d3700;--accent-glow:rgba(255,230,0,0.15);
    --green:#22c55e;--green-dim:#14532d;
    --red:#ef4444;--red-dim:#7f1d1d;
    --text:#e8e8e8;--text-dim:#888;--text-faint:#444;
    --mono:'Share Tech Mono',monospace;
    --cond:'Barlow Condensed',sans-serif;
    --body:'Barlow',sans-serif;
    --safe-top:env(safe-area-inset-top,0px);
    --safe-bottom:env(safe-area-inset-bottom,0px);
  }
  *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
  html,body{background:var(--bg);color:var(--text);font-family:var(--body);height:100%;overflow:hidden;user-select:none;-webkit-user-select:none}
  body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:.4}

  #app{display:flex;flex-direction:column;height:100dvh}

  #topbar{padding:calc(var(--safe-top) + 12px) 16px 12px;background:var(--bg1);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;position:relative}
  #topbar::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:.5}
  .app-logo{font-family:var(--cond);font-weight:900;font-size:22px;letter-spacing:4px;color:var(--accent);text-transform:uppercase}
  .app-logo span{color:var(--text-dim);font-weight:300}
  #topbar-right{display:flex;gap:8px;align-items:center}
  .week-badge{font-family:var(--cond);font-size:11px;font-weight:700;letter-spacing:2px;padding:4px 10px;border-radius:2px;border:1px solid var(--accent);color:var(--accent);background:var(--accent-dim);text-transform:uppercase;cursor:pointer}

  #nav{display:flex;border-bottom:1px solid var(--border);background:var(--bg1);flex-shrink:0}
  .nav-btn{flex:1;padding:10px 4px;border:none;background:none;color:var(--text-dim);font-family:var(--cond);font-weight:700;font-size:11px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;position:relative;transition:color .2s;display:flex;flex-direction:column;align-items:center;gap:3px}
  .nav-btn svg{width:18px;height:18px}
  .nav-btn.active{color:var(--accent)}
  .nav-btn.active::after{content:'';position:absolute;bottom:0;left:20%;right:20%;height:2px;background:var(--accent);box-shadow:0 0 8px var(--accent)}

  #pages{flex:1;overflow:hidden;position:relative}
  .page{position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;display:none;padding-bottom:calc(var(--safe-bottom) + 80px)}
  .page.active{display:block}
  .page::-webkit-scrollbar{width:2px}
  .page::-webkit-scrollbar-thumb{background:var(--border-bright);border-radius:1px}

  .card{background:var(--bg1);border:1px solid var(--border);border-radius:2px;margin:12px 12px 0;padding:14px;position:relative;overflow:hidden}
  .card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--border-bright),transparent)}
  .card-title{font-family:var(--cond);font-weight:700;font-size:11px;letter-spacing:3px;color:var(--text-dim);text-transform:uppercase;margin-bottom:12px;display:flex;align-items:center;gap:8px}
  .card-title .accent-dot{width:5px;height:5px;border-radius:50%;background:var(--accent);box-shadow:0 0 6px var(--accent);flex-shrink:0}

  .section-header{font-family:var(--cond);font-weight:900;font-size:28px;letter-spacing:2px;text-transform:uppercase;padding:16px 16px 4px;color:var(--text);line-height:1}
  .section-sub{font-size:12px;color:var(--text-dim);font-weight:300;padding:0 16px 4px;letter-spacing:1px}

  .btn{border:none;cursor:pointer;font-family:var(--cond);font-weight:700;letter-spacing:2px;text-transform:uppercase;border-radius:2px;transition:all .15s;padding:10px 18px;font-size:13px}
  .btn-primary{background:var(--accent);color:#000;box-shadow:0 0 20px var(--accent-glow)}
  .btn-primary:active{transform:scale(.97);box-shadow:none}
  .btn-ghost{background:transparent;color:var(--text-dim);border:1px solid var(--border-bright)}
  .btn-ghost:active{background:var(--bg3)}
  .btn-sm{padding:6px 12px;font-size:11px}
  .btn-full{width:100%;display:block;text-align:center}
  .btn-icon{width:36px;height:36px;border-radius:2px;padding:0;display:flex;align-items:center;justify-content:center;background:var(--bg3);border:1px solid var(--border);color:var(--text-dim);cursor:pointer}
  .btn-icon:active{background:var(--border)}

  .input-group{margin-bottom:12px}
  .input-label{font-family:var(--cond);font-size:10px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;margin-bottom:5px;display:block}
  input[type=text],input[type=number],select,textarea{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:2px;color:var(--text);font-family:var(--mono);font-size:14px;padding:9px 11px;outline:none;transition:border-color .15s;-webkit-appearance:none;appearance:none}
  input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent-glow)}
  select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23888' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:30px}
  textarea{resize:vertical;min-height:64px;font-size:13px}
  input[type=range]{width:100%;-webkit-appearance:none;appearance:none;height:4px;background:var(--bg3);border-radius:2px;outline:none}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px var(--accent-glow);cursor:pointer}

  .tag{display:inline-block;font-family:var(--cond);font-size:10px;letter-spacing:1.5px;text-transform:uppercase;padding:3px 8px;border-radius:2px;font-weight:700}
  .tag-green{background:var(--green-dim);color:var(--green)}
  .tag-red{background:var(--red-dim);color:var(--red)}
  .tag-orange{background:var(--accent-dim);color:var(--accent)}
  .tag-gray{background:var(--bg3);color:var(--text-dim)}

  .stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .stat-block{background:var(--bg2);border:1px solid var(--border);border-radius:2px;padding:10px 12px}
  .stat-label{font-family:var(--cond);font-size:9px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;margin-bottom:3px}
  .stat-value{font-family:var(--mono);font-size:20px;color:var(--text)}
  .stat-value.accent{color:var(--accent)}
  .stat-sub{font-size:10px;color:var(--text-dim);font-family:var(--mono);margin-top:2px}

  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:flex-end;z-index:1000;opacity:0;pointer-events:none;transition:opacity .2s}
  .modal-overlay.open{opacity:1;pointer-events:all}
  .modal{background:var(--bg1);border-top:1px solid var(--border);border-left:1px solid var(--border);border-right:1px solid var(--border);border-radius:4px 4px 0 0;width:100%;max-height:92dvh;overflow-y:auto;padding:20px 16px calc(var(--safe-bottom) + 20px);transform:translateY(100%);transition:transform .3s cubic-bezier(.32,.72,0,1)}
  .modal-overlay.open .modal{transform:translateY(0)}
  .modal-handle{width:36px;height:4px;background:var(--border-bright);border-radius:2px;margin:0 auto 20px;display:block}
  .modal-title{font-family:var(--cond);font-weight:900;font-size:22px;letter-spacing:2px;text-transform:uppercase;margin-bottom:16px;color:var(--accent)}

  .feedback-banner{border-radius:2px;padding:12px 14px;margin:0 12px 0;display:none;border-left:3px solid;animation:slideDown .3s ease}
  @keyframes slideDown{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
  .feedback-banner.show{display:block}
  .feedback-banner.good{background:var(--green-dim);border-color:var(--green)}
  .feedback-banner.warn{background:#1c1a00;border-color:#a07700}
  .feedback-banner.drop{background:var(--red-dim);border-color:var(--red)}
  .feedback-banner.up{background:var(--accent-dim);border-color:var(--accent)}
  .feedback-title{font-family:var(--cond);font-weight:700;font-size:13px;letter-spacing:2px;text-transform:uppercase;margin-bottom:4px}
  .feedback-body{font-size:13px;color:var(--text-dim);line-height:1.4}

  .set-row{display:flex;align-items:center;gap:8px;padding:10px 0;border-bottom:1px solid var(--border);animation:fadeIn .2s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateX(-4px)}to{opacity:1;transform:none}}
  .set-row:last-child{border-bottom:none}
  .set-num{font-family:var(--mono);font-size:11px;color:var(--text-faint);width:20px;flex-shrink:0}
  .set-data{flex:1;display:flex;gap:6px;flex-wrap:wrap}
  .set-chip{font-family:var(--mono);font-size:12px;padding:3px 7px;background:var(--bg2);border:1px solid var(--border);border-radius:2px;color:var(--text-dim)}
  .set-chip.pr{border-color:var(--accent);color:var(--accent);background:var(--accent-glow)}
  .set-rpe-chip{font-family:var(--mono);font-size:12px;padding:3px 7px;border-radius:2px;border:1px solid}
  .rpe-low{color:var(--green);border-color:var(--green);background:var(--green-dim)}
  .rpe-med{color:#a07700;border-color:#a07700;background:#1c1a00}
  .rpe-high{color:var(--accent);border-color:var(--accent-dim);background:var(--accent-glow)}
  .rpe-max{color:var(--red);border-color:var(--red-dim);background:var(--red-dim)}

  .exercise-item{padding:12px 0;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:12px}
  .exercise-item:last-child{border-bottom:none}
  .exercise-name{font-weight:500;font-size:15px;flex:1}
  .exercise-meta{font-family:var(--cond);font-size:11px;color:var(--text-dim);letter-spacing:1px;margin-top:2px}

  .day-pills{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
  .day-pill{font-family:var(--cond);font-weight:700;font-size:11px;letter-spacing:1.5px;padding:5px 10px;border-radius:2px;cursor:pointer;text-transform:uppercase;border:1px solid var(--border);background:var(--bg2);color:var(--text-dim);transition:all .15s}
  .day-pill.active{background:var(--accent);color:#000;border-color:var(--accent);box-shadow:0 0 12px var(--accent-glow)}
  .day-pill.has-workout{border-color:var(--border-bright);color:var(--text)}

  .week-tabs{display:flex;gap:4px;margin-bottom:10px}
  .week-tab{flex:1;padding:8px 4px;border:1px solid var(--border);background:var(--bg2);border-radius:2px;font-family:var(--cond);font-weight:700;font-size:12px;letter-spacing:1px;text-transform:uppercase;color:var(--text-dim);text-align:center;line-height:1.3}
  .week-tab.current{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
  .week-tab.done{border-color:var(--green-dim);color:var(--green);background:var(--green-dim)}

  .block-week-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:8px 10px;background:var(--bg2);border:1px solid var(--border);border-radius:2px}
  .block-week-row.current-w{border-color:var(--accent)}
  .block-week-num{font-family:var(--cond);font-weight:700;font-size:12px;color:var(--text-dim);letter-spacing:1px;width:32px;flex-shrink:0;line-height:1.3}
  .block-week-row.current-w .block-week-num{color:var(--accent)}

  #rest-timer{position:fixed;bottom:calc(var(--safe-bottom) + 70px);left:12px;right:12px;background:var(--bg2);border:1px solid var(--accent);border-radius:2px;padding:10px 14px;display:none;align-items:center;gap:12px;z-index:500;box-shadow:0 0 20px var(--accent-glow);animation:slideUp .3s ease}
  @keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:none;opacity:1}}
  #rest-timer.show{display:flex}
  #rest-timer-bar{height:3px;background:var(--bg3);border-radius:1px;margin-top:4px}
  #rest-timer-fill{height:100%;background:var(--accent);border-radius:1px;transition:width 1s linear;box-shadow:0 0 6px var(--accent)}
  .timer-wrap{flex:1}

  .muscle-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .muscle-name{font-family:var(--cond);font-size:12px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;width:90px;flex-shrink:0}
  .muscle-bar-wrap{flex:1;height:8px;background:var(--bg3);border-radius:1px;overflow:hidden}
  .muscle-bar{height:100%;border-radius:1px;transition:width .5s cubic-bezier(.34,1.56,.64,1)}
  .muscle-sets{font-family:var(--mono);font-size:11px;color:var(--text-dim);width:30px;text-align:right;flex-shrink:0}

  .divider-label{display:flex;align-items:center;gap:8px;margin:12px 0;font-family:var(--cond);font-size:10px;letter-spacing:2px;color:var(--text-faint);text-transform:uppercase}
  .divider-label::before,.divider-label::after{content:'';flex:1;height:1px;background:var(--border)}

  .pr-badge{display:inline-flex;align-items:center;gap:4px;font-family:var(--cond);font-size:10px;font-weight:700;letter-spacing:1px;padding:2px 7px;border-radius:2px;background:var(--accent-glow);border:1px solid var(--accent);color:var(--accent)}

  .empty-state{text-align:center;padding:40px 24px;color:var(--text-faint)}
  .empty-icon{font-size:32px;margin-bottom:12px;opacity:.4}
  .empty-text{font-family:var(--cond);font-size:14px;letter-spacing:2px;text-transform:uppercase}
  .empty-sub{font-size:13px;margin-top:6px}

  .cycle-banner{margin:12px;padding:14px;background:var(--accent-dim);border:1px solid var(--accent);border-radius:2px}
  .cycle-banner-title{font-family:var(--cond);font-weight:900;font-size:16px;letter-spacing:2px;color:var(--accent);text-transform:uppercase;margin-bottom:6px}
  .cycle-banner-body{font-size:13px;color:var(--text-dim);margin-bottom:12px;line-height:1.5}

  .prog-type-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px}
  .prog-type-btn{padding:14px 10px;border:1px solid var(--border);background:var(--bg2);border-radius:2px;text-align:center;cursor:pointer;transition:all .15s}
  .prog-type-btn.selected{border-color:var(--accent);background:var(--accent-dim)}
  .prog-type-btn .pt-icon{font-size:24px;margin-bottom:6px}
  .prog-type-btn .pt-label{font-family:var(--cond);font-weight:700;font-size:13px;letter-spacing:1px;text-transform:uppercase;color:var(--text)}
  .prog-type-btn.selected .pt-label{color:var(--accent)}
  .prog-type-btn .pt-sub{font-size:11px;color:var(--text-dim);margin-top:3px}

  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .gap-8{gap:8px}.mt-8{margin-top:8px}.mt-12{margin-top:12px}.mt-16{margin-top:16px}.mb-8{margin-bottom:8px}
  .text-accent{color:var(--accent)}.text-dim{color:var(--text-dim)}.mono{font-family:var(--mono)}
  canvas{width:100%!important}
  @keyframes popIn{0%{transform:scale(0);opacity:0}60%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}
  .pop{animation:popIn .3s cubic-bezier(.34,1.56,.64,1)}
</style>
</head>
<body>
<div id="app">
  <div id="topbar">
    <div class="app-logo">CHAR<span>GED</span></div>
    <div id="topbar-right">
      <div id="workout-timer" class="mono" style="font-size:14px;color:var(--text-dim);display:none"></div>
      <div id="week-badge-wrap"></div>
      <button class="btn-icon" onclick="openModal('settings-modal')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      </button>
    </div>
  </div>

  <div id="nav">
    <button class="nav-btn active" onclick="showPage('today')" id="nav-today">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>Today
    </button>
    <button class="nav-btn" onclick="showPage('plan')" id="nav-plan">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Plan
    </button>
    <button class="nav-btn" onclick="showPage('history')" id="nav-history">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>Progress
    </button>
    <button class="nav-btn" onclick="showPage('volume')" id="nav-volume">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="6" height="18"/><rect x="9" y="8" width="6" height="13"/><rect x="16" y="13" width="6" height="8"/></svg>Volume
    </button>
  </div>

  <div id="pages">
    <div class="page active" id="page-today"><div id="today-content"></div></div>
    <div class="page" id="page-plan"><div id="plan-content"></div></div>
    <div class="page" id="page-history">
      <div class="section-header">Progress</div>
      <div class="section-sub">1RM estimates & personal records</div>
      <div id="history-content"></div>
    </div>
    <div class="page" id="page-volume">
      <div class="section-header">Weekly Volume</div>
      <div class="section-sub">Sets per muscle group this week</div>
      <div id="volume-content"></div>
    </div>
  </div>

  <div id="rest-timer">
    <div class="timer-wrap">
      <div class="flex-between mb-8">
        <div>
          <div id="rest-timer-label" style="font-family:var(--cond);font-size:10px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase">Rest Timer</div>
          <div id="rest-timer-reason" style="font-size:10px;color:var(--text-faint);font-family:var(--cond);letter-spacing:1px;margin-top:1px"></div>
        </div>
        <div id="rest-timer-count" style="font-family:var(--mono);font-size:28px;color:var(--accent)">1:30</div>
      </div>
      <div id="rest-timer-bar"><div id="rest-timer-fill" style="width:100%"></div></div>
    </div>
    <button class="btn-icon" onclick="stopRestTimer()" style="flex-shrink:0">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="log-set-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="log-modal-title">Log Set</div>
    <div id="log-modal-body"></div>
  </div>
</div>

<div class="modal-overlay" id="add-exercise-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Add Exercise</div>
    <div class="input-group"><label class="input-label">Exercise Name</label><input type="text" id="ex-name-input" placeholder="e.g. Bench Press"></div>
    <div class="input-group"><label class="input-label">Muscle Group</label>
      <select id="ex-muscle-input">
        <option value="Chest">Chest</option><option value="Back">Back</option><option value="Shoulders">Shoulders</option>
        <option value="Biceps">Biceps</option><option value="Triceps">Triceps</option><option value="Legs">Legs</option>
        <option value="Glutes">Glutes</option><option value="Core">Core</option><option value="Calves">Calves</option>
      </select>
    </div>
    <div class="input-group"><label class="input-label">Target Sets</label><input type="number" id="ex-sets-input" value="4" min="1" max="10"></div>
    <div id="ex-weekly-fields">
      <div class="input-group"><label class="input-label">Rep Range</label>
        <select id="ex-reprange-input">
          <option value="1-3">1‚Äì3 (Max Strength)</option><option value="4-6">4‚Äì6 (Strength)</option>
          <option value="6-8">6‚Äì8 (Strength-Hyp)</option><option value="8-12" selected>8‚Äì12 (Hypertrophy)</option>
          <option value="12-15">12‚Äì15 (Hyp-Endurance)</option><option value="15-20">15‚Äì20 (Endurance)</option>
        </select>
      </div>
    </div>
    <div id="ex-block-fields" style="display:none">
      <div style="font-family:var(--cond);font-size:10px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;margin-bottom:8px">Rep Range Per Week</div>
      <div id="block-week-rows"></div>
    </div>
    <div class="input-group"><label class="input-label">Base Weight (kg)</label><input type="number" id="ex-weight-input" placeholder="60" step="0.5"></div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeModal('add-exercise-modal')">Cancel</button>
      <button class="btn btn-primary" style="flex:1" onclick="saveExercise()">Add</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="advance-week-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="advance-modal-title">Advance Week</div>
    <div id="advance-modal-body"></div>
  </div>
</div>

<div class="modal-overlay" id="settings-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Settings</div>
    <div style="font-family:var(--cond);font-size:10px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;margin-bottom:10px">Program Structure</div>
    <div class="prog-type-grid">
      <div class="prog-type-btn selected" id="ptype-weekly" onclick="setProgramType('weekly')">
        <div class="pt-icon">üîÅ</div><div class="pt-label">Weekly</div><div class="pt-sub">Same rep ranges every week</div>
      </div>
      <div class="prog-type-btn" id="ptype-block" onclick="setProgramType('block')">
        <div class="pt-icon">üìÖ</div><div class="pt-label">Block (4-week)</div><div class="pt-sub">Rep ranges change each week</div>
      </div>
    </div>
    <div id="block-length-row" style="display:none" class="input-group">
      <label class="input-label">Block Length (weeks)</label>
      <select id="setting-block-length">
        <option value="3">3 weeks</option><option value="4" selected>4 weeks</option>
        <option value="5">5 weeks</option><option value="6">6 weeks</option>
      </select>
    </div>
    <div class="divider-label">Rest Timers</div>
    <div class="input-group">
      <label class="input-label">Rest Time Multiplier</label>
      <select id="setting-rest">
        <option value="0.75">0.75x ‚Äî Shorter</option>
        <option value="1.0" selected>1.0x ‚Äî Default (evidence-based)</option>
        <option value="1.25">1.25x ‚Äî Slightly longer</option>
        <option value="1.5">1.5x ‚Äî Longer</option>
        <option value="2.0">2.0x ‚Äî Max</option>
      </select>
      <div style="margin-top:6px;font-family:var(--cond);font-size:10px;color:var(--text-faint);letter-spacing:1px;line-height:1.6">1‚Äì3 reps: 4 min ¬∑ 4‚Äì6: 3 min ¬∑ 6‚Äì8: 2:30<br>8‚Äì12: 1:30 ¬∑ 12‚Äì15: 1 min ¬∑ 15‚Äì20: 40s</div>
    </div>
    <div class="divider-label">Overload Rules</div>
    <div style="display:flex;gap:8px">
      <div class="input-group" style="flex:1"><label class="input-label">Drop % (RPE too high)</label><input type="number" id="setting-drop" value="10" min="5" max="25"></div>
      <div class="input-group" style="flex:1"><label class="input-label">Increase % (RPE too low)</label><input type="number" id="setting-increase" value="5" min="2" max="15"></div>
    </div>
    <button class="btn btn-primary btn-full mt-16" onclick="saveSettings();closeModal('settings-modal')">Save Settings</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];

const RPE_TARGETS = {'1-3':9.5,'4-6':8.75,'6-8':8.25,'8-12':7.75,'12-15':7.25,'15-20':6.75};

const REST_TIMES = {
  '1-3': {base:240,label:'Max Strength',reason:'CNS & neural recovery'},
  '4-6': {base:180,label:'Strength',reason:'Heavy load recovery'},
  '6-8': {base:150,label:'Str-Hyp',reason:'Balanced recovery'},
  '8-12':{base:90, label:'Hypertrophy',reason:'Metabolic stress window'},
  '12-15':{base:60,label:'Hyp-Endurance',reason:'Keep lactate elevated'},
  '15-20':{base:40,label:'Endurance',reason:'Minimal rest, sustained effort'},
};

// % of 1RM by rep count
const ONE_RM_PCT = {1:1.00,2:0.97,3:0.94,4:0.91,5:0.88,6:0.85,7:0.83,8:0.80,9:0.77,10:0.75,11:0.72,12:0.70,13:0.68,14:0.66,15:0.65,16:0.63,17:0.62,18:0.61,19:0.60,20:0.58};

const REP_LABELS = {'1-3':'1‚Äì3 (Max Strength)','4-6':'4‚Äì6 (Strength)','6-8':'6‚Äì8 (Str-Hyp)','8-12':'8‚Äì12 (Hypertrophy)','12-15':'12‚Äì15 (Hyp-End)','15-20':'15‚Äì20 (Endurance)'};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let state = {
  program: {type:'weekly', blockLength:4, currentWeek:1, cycleCount:1, showCycleReset:false},
  plan: {},
  sessions: [],
  settings: {restMultiplier:1.0, dropPct:10, increasePct:5},
  activePlanDay: 'Monday',
  currentSession: null,
  workoutStartTime: null,
  workoutTimerInterval: null,
  restTimerInterval: null,
};

function loadState() {
  try {
    const saved = localStorage.getItem('charged-v2');
    if (saved) {
      const p = JSON.parse(saved);
      state.program  = {...state.program,  ...(p.program  || {})};
      state.plan     = p.plan     || {};
      state.sessions = p.sessions || [];
      state.settings = {...state.settings, ...(p.settings || {})};
    }
  } catch(e) {}
}

function saveState() {
  localStorage.setItem('charged-v2', JSON.stringify({
    program:state.program, plan:state.plan,
    sessions:state.sessions, settings:state.settings,
  }));
}

loadState();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PERIODIZATION HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const isBlock   = () => state.program.type === 'block';
const curWeek   = () => state.program.currentWeek;
const blockLen  = () => state.program.blockLength || 4;

function getExRepRange(ex) {
  if (!isBlock() || !ex.weeks) return ex.repRange || '8-12';
  const wk = curWeek() - 1;
  return (ex.weeks[Math.min(wk, ex.weeks.length-1)] || ex.weeks[0]).repRange;
}

function getExTargetRPE(ex) {
  if (!isBlock() || !ex.weeks) return RPE_TARGETS[ex.repRange] || 7.5;
  const wk = curWeek() - 1;
  const w  = ex.weeks[Math.min(wk, ex.weeks.length-1)] || ex.weeks[0];
  return w.targetRPE || RPE_TARGETS[w.repRange] || 7.5;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 1RM ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const calcEpley = (w, r) => r === 1 ? w : Math.round(w * (1 + r/30) * 10) / 10;
const roundW    = w => Math.round(w * 2) / 2;

function getBest1RM(exerciseId) {
  let best = 0;
  for (const s of state.sessions)
    for (const ex of s.exercises)
      if (ex.exerciseId === exerciseId)
        for (const set of ex.sets) { const e = calcEpley(set.weight, set.reps); if (e > best) best = e; }
  return best;
}

function weightFor1RM(oneRM, repRange) {
  if (!oneRM) return null;
  const [lo, hi] = repRange.split('-').map(Number);
  // Use min reps of the range (heaviest end = more conservative safe estimate)
  const pct = ONE_RM_PCT[lo] || 0.75;
  return roundW(oneRM * pct);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OVERLOAD ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const getRPEClass = rpe => rpe <= 6 ? 'rpe-low' : rpe <= 7.5 ? 'rpe-med' : rpe <= 8.5 ? 'rpe-high' : 'rpe-max';

function getRestConf(repRange) {
  const c = REST_TIMES[repRange];
  if (!c) return {seconds:90,label:'Rest',reason:''};
  return {seconds: Math.round(c.base * (state.settings.restMultiplier||1)), label:c.label, reason:c.reason};
}

function overloadFeedback(ex, setData) {
  const rr     = getExRepRange(ex);
  const target = getExTargetRPE(ex);
  const diff   = setData.rpe - target;
  const [lo, hi] = rr.split('-').map(Number);
  const drop   = state.settings.dropPct  / 100;
  const inc    = state.settings.increasePct / 100;

  if (diff >= 2) {
    const nw = roundW(setData.weight * (1 - drop));
    return {type:'drop', title:'üîª Too Heavy', msg:`RPE ${setData.rpe} vs target ${target}. Drop to ${nw}kg, reset to ${lo} reps.`, suggested:{weight:nw, reps:lo}};
  }
  if (diff >= 1)   return {type:'warn', title:'‚ö†Ô∏è Slightly Over',  msg:`RPE ${setData.rpe} vs target ${target}. Try slowing eccentric +1s next set.`, suggested:null};
  if (diff <= -2) {
    const nw = roundW(setData.weight * (1 + inc));
    return {type:'up',   title:'‚¨ÜÔ∏è Too Easy',   msg:`RPE ${setData.rpe} vs target ${target}. Increase to ${nw}kg next set.`, suggested:{weight:nw, reps:setData.reps}};
  }
  if (diff <= -1)  return {type:'up',   title:'‚ûï Room to Grow',   msg:`RPE ${setData.rpe} vs target ${target}. Add 1 rep next set.`, suggested:null};
  if (setData.reps >= hi && Math.abs(diff) <= 0.5) {
    const nw = roundW(setData.weight * (1 + inc));
    return {type:'good', title:'üèÜ Progress!',   msg:`Hit top of rep range at target RPE. Next session: ${nw}kg.`, suggested:{weight:nw, reps:lo}};
  }
  return {type:'good', title:'‚úÖ On Target', msg:`RPE ${setData.rpe} matches target ${target}. Keep weight.`, suggested:null};
}

function getNextSuggestion(ex) {
  const rr   = getExRepRange(ex);
  const [lo] = rr.split('-').map(Number);

  // Find most recent session sets for this exercise
  for (const session of [...state.sessions].reverse()) {
    const se = session.exercises.find(e => e.exerciseId === ex.id);
    if (se && se.sets.length) {
      const last = se.sets[se.sets.length - 1];
      // If session was for same week/rep-range context, apply overload
      const fb = overloadFeedback(ex, last);
      if (fb.suggested) return {...fb.suggested, estimated:false};
      return {weight:last.weight, reps:last.reps, estimated:false};
    }
  }

  // No history ‚Äî use 1RM to estimate
  const oneRM = getBest1RM(ex.id);
  if (oneRM > 0) {
    const estW = weightFor1RM(oneRM, rr);
    if (estW) return {weight:estW, reps:lo, estimated:true, oneRM};
  }

  return {weight: ex.baseWeight || 20, reps:lo, estimated:false};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id) { document.getElementById(id).classList.add('open'); document.body.style.overflow='hidden'; }
function closeModal(id) { document.getElementById(id).classList.remove('open'); document.body.style.overflow=''; }
document.querySelectorAll('.modal-overlay').forEach(el => el.addEventListener('click', e => { if (e.target===el) closeModal(el.id); }));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  document.getElementById('nav-'+name).classList.add('active');
  if (name==='today')   renderToday();
  if (name==='plan')    renderPlan();
  if (name==='history') renderHistory();
  if (name==='volume')  renderVolume();
}

function updateWeekBadge() {
  const el = document.getElementById('week-badge-wrap');
  if (!isBlock()) { el.innerHTML = ''; return; }
  el.innerHTML = `<div class="week-badge" onclick="openAdvanceModal()">W${curWeek()}/${blockLen()}</div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TODAY PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getTodayDay() {
  return ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][new Date().getDay()];
}

function weekProgressionChips(ex) {
  if (!isBlock() || !ex.weeks) return '';
  const wk = curWeek(), bl = blockLen();
  return '<div style="display:flex;gap:4px;margin-top:5px;flex-wrap:wrap">' +
    ex.weeks.slice(0, bl).map((w, i) => {
      const n = i+1;
      const s = n===wk ? 'background:var(--accent-dim);border-color:var(--accent);color:var(--accent)' :
                n <wk  ? 'background:var(--green-dim);border-color:var(--green-dim);color:var(--green)' :
                         'background:transparent;border-color:var(--border);color:var(--text-faint)';
      return `<span style="font-family:var(--cond);font-size:9px;letter-spacing:1px;padding:2px 5px;border:1px solid;border-radius:2px;${s}">${w.repRange}</span>`;
    }).join('') + '</div>';
}

function renderToday() {
  const today = getTodayDay();
  const exercises = state.plan[today] || [];
  const el = document.getElementById('today-content');
  const sessionToday = (state.currentSession && state.currentSession.day===today) ? state.currentSession : null;
  let html = '';

  if (isBlock() && state.program.showCycleReset) {
    html += `<div class="cycle-banner">
      <div class="cycle-banner-title">‚ö° Block Complete!</div>
      <div class="cycle-banner-body">You've finished a full ${blockLen()}-week block (Cycle ${state.program.cycleCount}). New starting weights have been estimated for Cycle ${state.program.cycleCount+1} using your improved 1RM. Check Plan to review them.</div>
      <button class="btn btn-primary btn-sm" onclick="startNewCycle()">Start Cycle ${state.program.cycleCount+1}</button>
    </div>`;
  }

  const weekTag = isBlock() ? ` <span class="tag tag-orange" style="font-size:9px;vertical-align:middle">WEEK ${curWeek()}</span>` : '';

  if (!exercises.length) {
    html += `<div class="section-header">${today}${weekTag}</div>
      <div class="section-sub">Rest day</div>
      <div class="card"><div class="empty-state">
        <div class="empty-icon">üõå</div>
        <div class="empty-text">Rest & Recover</div>
        <div class="empty-sub">No workout today. Add exercises in Plan.</div>
      </div></div>`;
    el.innerHTML = html; return;
  }

  html += `<div class="section-header">${today}${weekTag}</div>`;

  if (!sessionToday) {
    html += `<div class="card"><div class="flex-between">
      <div>
        <div style="font-family:var(--cond);font-weight:700;font-size:16px;letter-spacing:1px">Ready to train?</div>
        <div style="color:var(--text-dim);font-size:13px;margin-top:4px">${exercises.map(e=>e.name).join(' ¬∑ ')}</div>
      </div>
      <button class="btn btn-primary" onclick="startWorkout('${today}')">Start</button>
    </div></div>`;

    html += `<div class="card"><div class="card-title"><div class="accent-dot"></div>Today's Plan</div>`;
    for (const ex of exercises) {
      const rr = getExRepRange(ex);
      const sg = getNextSuggestion(ex);
      const pr = getBest1RM(ex.id);
      html += `<div class="exercise-item" style="cursor:default">
        <div style="flex:1">
          <div class="exercise-name">${ex.name}</div>
          <div class="exercise-meta">${ex.sets} sets ¬∑ ${rr} reps ¬∑ <span class="text-accent">${sg.weight}kg${sg.estimated?' <span style="font-size:10px;color:var(--text-faint)">(est.)</span>':''}</span></div>
          ${weekProgressionChips(ex)}
          ${pr > 0 ? `<div style="margin-top:5px"><span class="pr-badge">üèÜ 1RM~${pr}kg</span></div>` : ''}
        </div>
        <div class="tag tag-gray">${ex.muscle}</div>
      </div>`;
    }
    html += `</div>`;
  } else {
    // Active workout
    html += `<div id="feedback-area"></div>`;
    for (const ex of exercises) {
      const se = sessionToday.exercises.find(e => e.exerciseId===ex.id);
      const logged = se ? se.sets : [];
      const rr = getExRepRange(ex);
      const [lo] = rr.split('-').map(Number);
      let sg;
      if (logged.length > 0) {
        const fb = overloadFeedback(ex, logged[logged.length-1]);
        sg = fb.suggested || {weight:logged[logged.length-1].weight, reps:logged[logged.length-1].reps};
      } else { sg = getNextSuggestion(ex); }

      html += `<div class="card" id="ex-card-${ex.id}">
        <div class="flex-between mb-8">
          <div>
            <div style="font-family:var(--cond);font-weight:900;font-size:18px;letter-spacing:1px;text-transform:uppercase">${ex.name}</div>
            <div class="exercise-meta">${ex.sets} sets ¬∑ ${rr} reps ¬∑ <span class="text-accent">Target ${sg.weight}kg √ó ${sg.reps||lo}${sg.estimated?' <span style="font-size:10px;color:var(--text-faint)">(est.)</span>':''}</span></div>
          </div>
          <div class="tag tag-gray">${ex.muscle}</div>
        </div>
        <div id="sets-${ex.id}">`;

      logged.forEach((s, i) => {
        const est = calcEpley(s.weight, s.reps);
        const pr  = getBest1RM(ex.id);
        const isPR = est>0 && est>=pr;
        html += `<div class="set-row">
          <div class="set-num">${i+1}</div>
          <div class="set-data">
            <span class="set-chip">${s.weight}kg</span>
            <span class="set-chip">${s.reps} reps</span>
            <span class="set-rpe-chip ${getRPEClass(s.rpe)}">RPE ${s.rpe}</span>
            ${s.tempo&&s.tempo!=='0-0-0-0'?`<span class="set-chip">${s.tempo}</span>`:''}
            ${isPR?`<span class="set-chip pr pop">üèÜ PR</span>`:''}
            <span class="set-chip" style="color:var(--text-faint);font-size:11px">1RM~${est}kg</span>
          </div>
        </div>`;
      });

      html += `</div>`;
      const setsLeft = ex.sets - logged.length;
      if (setsLeft > 0) {
        html += `<button class="btn btn-primary btn-full mt-8" onclick="openLogSet('${ex.id}','${today}')">+ Log Set ${logged.length+1} / ${ex.sets}</button>`;
      } else {
        html += `<div class="tag tag-green mt-8 pop" style="display:inline-block">‚úì Complete</div>`;
      }
      html += `</div>`;
    }

    html += `<div class="card"><button class="btn btn-ghost btn-full" onclick="finishWorkout()">Finish Workout</button></div>`;
  }

  el.innerHTML = html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORKOUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startWorkout(day) {
  state.currentSession = {
    date: new Date().toISOString().split('T')[0], day, week:curWeek(),
    exercises: (state.plan[day]||[]).map(ex => ({exerciseId:ex.id, name:ex.name, sets:[]}))
  };
  state.workoutStartTime = Date.now();
  document.getElementById('workout-timer').style.display = 'block';
  state.workoutTimerInterval = setInterval(() => {
    const e = Math.floor((Date.now()-state.workoutStartTime)/1000);
    document.getElementById('workout-timer').textContent =
      `${Math.floor(e/60).toString().padStart(2,'0')}:${(e%60).toString().padStart(2,'0')}`;
  }, 1000);
  renderToday();
}

function finishWorkout() {
  if (!state.currentSession) return;
  state.sessions.push({...state.currentSession});
  state.currentSession = null;
  clearInterval(state.workoutTimerInterval);
  document.getElementById('workout-timer').style.display = 'none';
  saveState(); renderToday();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOG SET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let logCtx = null;

function openLogSet(exId, day) {
  const ex = (state.plan[day]||[]).find(e => e.id===exId);
  if (!ex) return;
  const se = state.currentSession.exercises.find(e => e.exerciseId===exId);
  const prev = se ? se.sets : [];
  const setNum = prev.length + 1;
  const rr = getExRepRange(ex);
  const [lo] = rr.split('-').map(Number);
  const tRPE = getExTargetRPE(ex);

  let sg;
  if (prev.length > 0) {
    const fb = overloadFeedback(ex, prev[prev.length-1]);
    sg = fb.suggested || {weight:prev[prev.length-1].weight, reps:prev[prev.length-1].reps};
  } else { sg = getNextSuggestion(ex); }

  logCtx = {exId, day, setNum, ex};
  document.getElementById('log-modal-title').textContent = `${ex.name} ‚Äî Set ${setNum}`;
  const oneRM = getBest1RM(exId);
  const estNote = sg.estimated && oneRM > 0
    ? `<div style="font-size:11px;color:var(--text-faint);margin-top:2px;font-family:var(--cond);letter-spacing:1px">From 1RM ${oneRM}kg ¬∑ ${Math.round(sg.weight/oneRM*100)}% of max</div>` : '';

  document.getElementById('log-modal-body').innerHTML = `
    <div style="background:var(--bg2);border:1px solid var(--border);border-radius:2px;padding:10px 12px;margin-bottom:16px">
      <div style="font-family:var(--cond);font-size:10px;letter-spacing:2px;color:var(--text-dim);margin-bottom:4px;text-transform:uppercase">Target This Set</div>
      <div style="font-family:var(--mono);font-size:22px;color:var(--accent)">${sg.weight}kg √ó ${sg.reps||lo}</div>
      <div style="font-size:12px;color:var(--text-dim);margin-top:2px">Target RPE: ${tRPE} ¬∑ Range: ${rr}${isBlock()?` ¬∑ Week ${curWeek()}`:''}</div>
      ${estNote}
    </div>
    <div style="display:flex;gap:8px">
      <div class="input-group" style="flex:1"><label class="input-label">Weight (kg)</label><input type="number" id="log-weight" value="${sg.weight}" step="0.5" min="0"></div>
      <div class="input-group" style="flex:1"><label class="input-label">Reps</label><input type="number" id="log-reps" value="${sg.reps||lo}" min="1" max="50"></div>
    </div>
    <div class="input-group">
      <label class="input-label">RPE / Difficulty ‚Äî <span id="rpe-display" class="text-accent">${tRPE}</span> / 10</label>
      <input type="range" id="log-rpe" min="1" max="10" step="0.5" value="${tRPE}" oninput="document.getElementById('rpe-display').textContent=this.value">
    </div>
    <div class="input-group">
      <label class="input-label">Tempo (ecc ‚Äì bot ‚Äì con ‚Äì top)</label>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px">
        ${['Ecc','Bot','Con','Top'].map((l,i)=>`<div>
          <div style="font-family:var(--cond);font-size:9px;color:var(--text-faint);text-align:center;margin-bottom:3px;letter-spacing:1px;text-transform:uppercase">${l}</div>
          <input type="number" id="t${i+1}" value="${i===0?3:i===2?1:0}" min="0" max="10" style="text-align:center;padding:8px 4px">
        </div>`).join('')}
      </div>
    </div>
    <div class="input-group"><label class="input-label">Notes (optional)</label><textarea id="log-notes" placeholder="Form cues, how it felt..."></textarea></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeModal('log-set-modal')">Cancel</button>
      <button class="btn btn-primary" style="flex:1" onclick="saveSet()">Log Set</button>
    </div>`;
  openModal('log-set-modal');
}

function saveSet() {
  if (!logCtx) return;
  const weight = parseFloat(document.getElementById('log-weight').value)||0;
  const reps   = parseInt(document.getElementById('log-reps').value)||0;
  const rpe    = parseFloat(document.getElementById('log-rpe').value)||7;
  const tempo  = `${document.getElementById('t1').value}-${document.getElementById('t2').value}-${document.getElementById('t3').value}-${document.getElementById('t4').value}`;
  const notes  = document.getElementById('log-notes').value;
  const est1rm = calcEpley(weight, reps);

  const se = state.currentSession.exercises.find(e => e.exerciseId===logCtx.exId);
  if (se) se.sets.push({weight, reps, rpe, tempo, notes, est1rm});

  closeModal('log-set-modal');

  const fb = overloadFeedback(logCtx.ex, {weight, reps, rpe});
  const fEl = document.getElementById('feedback-area');
  if (fEl) {
    fEl.innerHTML = `<div class="feedback-banner show ${fb.type}" style="margin-top:12px">
      <div class="feedback-title">${fb.title}</div>
      <div class="feedback-body">${fb.msg}</div>
    </div>`;
    setTimeout(() => { const b = fEl.querySelector('.feedback-banner'); if(b) b.style.opacity='0.4'; }, 6000);
  }

  const rc = getRestConf(getExRepRange(logCtx.ex));
  startRestTimer(rc.seconds, rc.label, rc.reason);
  renderToday();
  setTimeout(() => document.getElementById('feedback-area')?.scrollIntoView({behavior:'smooth',block:'start'}), 100);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REST TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const fmtT = s => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;

function startRestTimer(seconds, label, reason) {
  stopRestTimer();
  let rem = seconds;
  const el    = document.getElementById('rest-timer');
  const count = document.getElementById('rest-timer-count');
  const fill  = document.getElementById('rest-timer-fill');
  document.getElementById('rest-timer-label').textContent = label ? `Rest ¬∑ ${label}` : 'Rest Timer';
  document.getElementById('rest-timer-reason').textContent = reason || '';
  el.classList.add('show');
  count.textContent = fmtT(rem);
  fill.style.width  = '100%';
  state.restTimerInterval = setInterval(() => {
    rem--; count.textContent = fmtT(rem);
    fill.style.width = (rem/seconds*100)+'%';
    if (rem <= 0) stopRestTimer();
  }, 1000);
}

function stopRestTimer() {
  clearInterval(state.restTimerInterval);
  document.getElementById('rest-timer').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAN PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderPlan() {
  const el = document.getElementById('plan-content');
  let html = `<div class="section-header">Training Plan</div>`;

  if (isBlock()) {
    const wk = curWeek(), bl = blockLen();
    let tabs = '<div style="padding:8px 12px 0"><div class="week-tabs">';
    for (let w=1; w<=bl; w++) {
      const cls = w===wk?'current':w<wk?'done':'';
      tabs += `<div class="week-tab ${cls}">W${w}${w===wk?'<br><span style="font-size:8px;letter-spacing:0">NOW</span>':''}</div>`;
    }
    tabs += `</div><div style="font-size:12px;color:var(--text-dim);font-family:var(--cond);letter-spacing:1px;padding-bottom:4px">
      Week ${wk} of ${bl} ¬∑ <span style="color:var(--accent);cursor:pointer" onclick="openAdvanceModal()">Advance week ‚Üí</span>
    </div></div>`;
    html += tabs;
  }

  html += `<div class="card"><div class="card-title"><div class="accent-dot"></div>Select Day</div>
    <div class="day-pills" id="plan-day-pills"></div>
    <div id="plan-day-content"></div>
  </div>`;

  el.innerHTML = html;

  document.getElementById('plan-day-pills').innerHTML = DAYS.map(d => {
    const has = (state.plan[d]||[]).length > 0;
    const act = state.activePlanDay === d;
    return `<div class="day-pill ${act?'active':''} ${has?'has-workout':''}" onclick="setPlanDay('${d}')">${d.slice(0,3)}</div>`;
  }).join('');

  renderPlanDay();
}

function setPlanDay(day) { state.activePlanDay = day; renderPlan(); }

function renderPlanDay() {
  const day = state.activePlanDay;
  const exercises = state.plan[day] || [];
  const el = document.getElementById('plan-day-content');
  let html = '';

  if (!exercises.length) {
    html = `<div class="empty-state" style="padding:20px 0"><div class="empty-text">Rest Day</div></div>`;
  } else {
    exercises.forEach((ex, i) => {
      const repDisplay = isBlock() && ex.weeks
        ? ex.weeks.slice(0,blockLen()).map((w,wi)=>`W${wi+1}: ${w.repRange}`).join(' ‚Üí ')
        : ex.repRange;
      html += `<div class="exercise-item" style="cursor:default">
        <div style="flex:1">
          <div class="exercise-name">${ex.name}</div>
          <div class="exercise-meta">${ex.sets} sets ¬∑ <span class="text-accent">${ex.muscle}</span></div>
          <div style="font-family:var(--cond);font-size:10px;color:var(--text-dim);margin-top:3px;letter-spacing:1px">${repDisplay}</div>
          ${weekProgressionChips(ex)}
        </div>
        <button class="btn-icon" onclick="removeExercise('${day}',${i})" style="color:var(--red);flex-shrink:0">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/></svg>
        </button>
      </div>`;
    });
  }
  html += `<button class="btn btn-ghost btn-full mt-8" onclick="openAddExercise()">+ Add Exercise</button>`;
  el.innerHTML = html;
}

function openAddExercise() {
  document.getElementById('ex-name-input').value = '';
  document.getElementById('ex-weight-input').value = '';
  const bk = isBlock();
  document.getElementById('ex-block-fields').style.display  = bk ? 'block' : 'none';
  document.getElementById('ex-weekly-fields').style.display = bk ? 'none'  : 'block';
  if (bk) buildBlockRows();
  openModal('add-exercise-modal');
}

function buildBlockRows() {
  const bl = blockLen(), wk = curWeek();
  const defaults = ['12-15','8-12','4-6','1-3','12-15','8-12'].slice(0, bl);
  const opts = Object.keys(REP_LABELS).map(r=>`<option value="${r}">${REP_LABELS[r]}</option>`).join('');
  document.getElementById('block-week-rows').innerHTML = Array.from({length:bl},(_,i)=>{
    const w = i+1, isCur = w===wk, def = defaults[i]||'8-12';
    return `<div class="block-week-row ${isCur?'current-w':''}">
      <div class="block-week-num">W${w}${isCur?'<br><span style="font-size:8px;color:var(--accent)">NOW</span>':''}</div>
      <select id="bw-${w}" style="flex:1">${opts.replace(`value="${def}"`,`value="${def}" selected`)}</select>
    </div>`;
  }).join('');
}

function saveExercise() {
  const name = document.getElementById('ex-name-input').value.trim();
  if (!name) { alert('Please enter a name'); return; }
  const muscle = document.getElementById('ex-muscle-input').value;
  const sets   = parseInt(document.getElementById('ex-sets-input').value)||4;
  const baseW  = parseFloat(document.getElementById('ex-weight-input').value)||20;
  const day    = state.activePlanDay;
  if (!state.plan[day]) state.plan[day] = [];

  if (isBlock()) {
    const weeks = Array.from({length:blockLen()},(_,i)=>{
      const rr = document.getElementById(`bw-${i+1}`).value;
      return {repRange:rr, targetRPE:RPE_TARGETS[rr]||7.5};
    });
    state.plan[day].push({id:Date.now().toString(), name, muscle, sets, baseWeight:baseW, weeks});
  } else {
    const repRange = document.getElementById('ex-reprange-input').value;
    state.plan[day].push({id:Date.now().toString(), name, muscle, sets, repRange, baseWeight:baseW});
  }
  saveState(); closeModal('add-exercise-modal'); renderPlan();
}

function removeExercise(day, i) {
  state.plan[day].splice(i, 1); saveState(); renderPlan();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEEK ADVANCE & CYCLE RESET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAdvanceModal() {
  const wk = curWeek(), bl = blockLen(), isLast = wk >= bl;
  document.getElementById('advance-modal-title').textContent = isLast ? '‚ö° Complete Block' : `Advance to Week ${wk+1}`;

  const allEx = {};
  for (const d of DAYS) for (const ex of (state.plan[d]||[])) allEx[ex.id] = ex;

  let html = '';
  if (isLast) {
    html += `<p style="font-size:14px;color:var(--text-dim);margin-bottom:16px;line-height:1.6">
      You've completed <strong style="color:var(--text)">Week ${bl} of ${bl}</strong> ‚Äî the full block (Cycle ${state.program.cycleCount}).
      The app will calculate new Week 1 starting weights for Cycle ${state.program.cycleCount+1} using your improved 1RM.
    </p>`;
    if (Object.keys(allEx).length) {
      html += `<div style="font-family:var(--cond);font-size:10px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;margin-bottom:8px">Cycle ${state.program.cycleCount+1} ‚Äî Week 1 Weights</div>`;
      for (const ex of Object.values(allEx)) {
        const oneRM = getBest1RM(ex.id);
        const firstRR = isBlock() && ex.weeks ? ex.weeks[0].repRange : (ex.repRange||'8-12');
        const estW = oneRM>0 ? weightFor1RM(oneRM, firstRR) : null;
        html += `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
          <div><div style="font-size:14px">${ex.name}</div>
               <div style="font-family:var(--cond);font-size:11px;color:var(--text-dim)">${firstRR} (W1)</div></div>
          <div style="text-align:right">
            <div style="font-family:var(--mono);font-size:16px;color:var(--accent)">${estW?estW+'kg':ex.baseWeight+'kg'}</div>
            ${oneRM>0?`<div style="font-family:var(--cond);font-size:10px;color:var(--text-faint)">1RM~${oneRM}kg</div>`:''}
          </div>
        </div>`;
      }
    }
    html += `<button class="btn btn-primary btn-full mt-16" onclick="startNewCycle();closeModal('advance-week-modal')">Start Cycle ${state.program.cycleCount+1}</button>`;
  } else {
    html += `<p style="font-size:14px;color:var(--text-dim);margin-bottom:16px;line-height:1.6">
      Moving from <strong style="color:var(--text)">Week ${wk}</strong> to <strong style="color:var(--accent)">Week ${wk+1}</strong>. Rep ranges and rest times will update for all exercises.
    </p>`;
    if (isBlock() && Object.keys(allEx).length) {
      html += `<div style="font-family:var(--cond);font-size:10px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;margin-bottom:8px">Rep Range Changes</div>`;
      for (const ex of Object.values(allEx)) {
        if (!ex.weeks) continue;
        const thisRR = ex.weeks[wk-1]?.repRange || '‚Äî';
        const nextRR = ex.weeks[wk]?.repRange   || '‚Äî';
        const oneRM  = getBest1RM(ex.id);
        const nextW  = oneRM>0 ? weightFor1RM(oneRM, nextRR) : null;
        html += `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);align-items:center">
          <div><div style="font-size:14px">${ex.name}</div>
               <div style="font-family:var(--mono);font-size:12px">
                 <span style="color:var(--text-faint)">${thisRR}</span>
                 <span style="color:var(--text-dim)"> ‚Üí </span>
                 <span style="color:var(--accent)">${nextRR}</span>
               </div></div>
          <div style="text-align:right">
            ${nextW?`<div style="font-family:var(--mono);font-size:15px;color:var(--accent)">~${nextW}kg</div>`:''}
            ${oneRM>0?`<div style="font-family:var(--cond);font-size:10px;color:var(--text-faint)">from 1RM ${oneRM}kg</div>`:''}
          </div>
        </div>`;
      }
    }
    html += `<button class="btn btn-primary btn-full mt-16" onclick="advanceWeek();closeModal('advance-week-modal')">Advance to Week ${wk+1}</button>`;
  }

  document.getElementById('advance-modal-body').innerHTML = html;
  openModal('advance-week-modal');
}

function advanceWeek() {
  state.program.currentWeek++;
  saveState(); updateWeekBadge(); renderToday(); renderPlan();
}

function startNewCycle() {
  state.program.currentWeek  = 1;
  state.program.cycleCount   = (state.program.cycleCount||1) + 1;
  state.program.showCycleReset = false;
  saveState(); updateWeekBadge(); renderToday(); renderPlan();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORY PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHistory() {
  const el = document.getElementById('history-content');
  const allEx = {};
  for (const d of DAYS) for (const ex of (state.plan[d]||[])) allEx[ex.id] = ex;
  if (!Object.keys(allEx).length) {
    el.innerHTML = `<div class="card"><div class="empty-state"><div class="empty-text">No exercises in plan yet</div></div></div>`;
    return;
  }
  let html = '';
  for (const [id, ex] of Object.entries(allEx)) {
    const hist = [];
    for (const s of state.sessions)
      for (const se of s.exercises)
        if (se.exerciseId===id && se.sets.length)
          hist.push({date:s.date, best:Math.max(...se.sets.map(st=>calcEpley(st.weight,st.reps))), week:s.week||1});
    const pr   = hist.length ? Math.max(...hist.map(h=>h.best)) : 0;
    const sg   = getNextSuggestion(ex);
    const rr   = getExRepRange(ex);

    html += `<div class="card">
      <div class="flex-between mb-8">
        <div>
          <div style="font-family:var(--cond);font-weight:900;font-size:17px;letter-spacing:1px;text-transform:uppercase">${ex.name}</div>
          <div class="exercise-meta">${rr} reps (current week) ¬∑ ${ex.muscle}</div>
        </div>
        ${pr>0?`<span class="pr-badge">üèÜ ${pr}kg</span>`:'<span class="tag tag-gray">No data</span>'}
      </div>
      <div class="stat-grid">
        <div class="stat-block"><div class="stat-label">Est. 1RM PR</div><div class="stat-value accent">${pr>0?pr+'kg':'‚Äî'}</div></div>
        <div class="stat-block">
          <div class="stat-label">Next Target</div>
          <div class="stat-value">${sg.weight}kg</div>
          <div class="stat-sub">${sg.reps||'‚Äî'} reps${sg.estimated?' (est.)':''}</div>
        </div>
      </div>
      ${isBlock() && ex.weeks ? renderWeekCells(ex, hist) : ''}
      ${hist.length >= 2 ? renderSparkline(hist) : ''}
    </div>`;
  }
  el.innerHTML = html;
}

function renderWeekCells(ex, hist) {
  const bl = blockLen();
  const byCycleWeek = {};
  for (const h of hist) byCycleWeek[h.week] = Math.max(byCycleWeek[h.week]||0, h.best);
  const cells = ex.weeks.slice(0,bl).map((w,i)=>{
    const wn=i+1, val=byCycleWeek[wn], isCur=wn===curWeek();
    return `<div style="flex:1;text-align:center;padding:6px 4px;border:1px solid ${isCur?'var(--accent)':'var(--border)'};background:${isCur?'var(--accent-dim)':'var(--bg2)'};border-radius:2px">
      <div style="font-family:var(--cond);font-size:9px;color:${isCur?'var(--accent)':'var(--text-faint)'};letter-spacing:1px">W${wn}</div>
      <div style="font-family:var(--mono);font-size:13px;color:${val?'var(--text)':'var(--text-faint)'}">${val?val+'kg':'‚Äî'}</div>
      <div style="font-family:var(--cond);font-size:8px;color:var(--text-faint)">${w.repRange}</div>
    </div>`;
  }).join('');
  return `<div style="margin-top:10px">
    <div style="font-family:var(--cond);font-size:9px;letter-spacing:2px;color:var(--text-faint);text-transform:uppercase;margin-bottom:6px">Best 1RM Est. Per Block Week</div>
    <div style="display:flex;gap:4px">${cells}</div>
  </div>`;
}

function renderSparkline(hist) {
  const sid = 'sp-'+Math.random().toString(36).slice(2,8);
  setTimeout(()=>{
    const c = document.getElementById(sid); if (!c) return;
    const ctx = c.getContext('2d');
    const W = c.offsetWidth*devicePixelRatio, H = 70*devicePixelRatio;
    c.width=W; c.height=H;
    const vals=hist.map(h=>h.best), mn=Math.min(...vals)*.95, mx=Math.max(...vals)*1.02;
    const sx=W/(vals.length-1||1), sy=H/(mx-mn||1);
    ctx.strokeStyle='#ffe600'; ctx.lineWidth=2*devicePixelRatio; ctx.lineJoin='round';
    ctx.shadowBlur=8*devicePixelRatio; ctx.shadowColor='#ffe600';
    ctx.beginPath();
    vals.forEach((v,i)=>{ const x=i*sx,y=H-(v-mn)*sy; i===0?ctx.moveTo(x,y):ctx.lineTo(x,y); });
    ctx.stroke();
    ctx.shadowBlur=0;
    ctx.lineTo((vals.length-1)*sx,H); ctx.lineTo(0,H); ctx.closePath();
    const g=ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'rgba(255,230,0,.25)'); g.addColorStop(1,'rgba(255,230,0,0)');
    ctx.fillStyle=g; ctx.fill();
    ctx.shadowBlur=6*devicePixelRatio; ctx.shadowColor='#ffe600'; ctx.fillStyle='#ffe600';
    vals.forEach((v,i)=>{ ctx.beginPath(); ctx.arc(i*sx,H-(v-mn)*sy,3*devicePixelRatio,0,Math.PI*2); ctx.fill(); });
  },50);
  return `<div style="margin-top:12px">
    <div style="font-family:var(--cond);font-size:9px;letter-spacing:2px;color:var(--text-faint);text-transform:uppercase;margin-bottom:4px">Est. 1RM Progress</div>
    <canvas id="${sid}" style="width:100%;height:70px;display:block"></canvas>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VOLUME PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderVolume() {
  const el = document.getElementById('volume-content');
  const today = new Date(), dow = today.getDay()||7;
  const wkStart = new Date(today); wkStart.setDate(today.getDate()-dow+1); wkStart.setHours(0,0,0,0);
  const muscles = {}; let tSets=0, tReps=0;
  const thisWeek = state.sessions.filter(s=>new Date(s.date)>=wkStart);
  for (const s of thisWeek) {
    for (const ex of s.exercises) {
      let m='Other';
      for (const d of DAYS) { const px=(state.plan[d]||[]).find(p=>p.id===ex.exerciseId); if(px){m=px.muscle;break;} }
      muscles[m]=(muscles[m]||0)+ex.sets.length;
      tSets+=ex.sets.length; tReps+=ex.sets.reduce((a,s)=>a+s.reps,0);
    }
  }
  if (!Object.keys(muscles).length) {
    el.innerHTML=`<div class="card"><div class="empty-state"><div class="empty-icon">üìä</div><div class="empty-text">No sessions this week yet</div></div></div>`;
    return;
  }
  const rec={Chest:12,Back:14,Shoulders:12,Biceps:10,Triceps:10,Legs:14,Glutes:12,Core:10,Calves:10};
  let html=`<div class="card"><div class="card-title"><div class="accent-dot"></div>This Week</div>
    <div class="stat-grid mb-8">
      <div class="stat-block"><div class="stat-label">Total Sets</div><div class="stat-value accent">${tSets}</div></div>
      <div class="stat-block"><div class="stat-label">Total Reps</div><div class="stat-value">${tReps}</div></div>
    </div><div class="divider-label">Muscle Volume</div>`;
  for (const [m,sets] of Object.entries(muscles).sort((a,b)=>b[1]-a[1])) {
    const r=rec[m]||12, p=Math.min(sets/r*100,100);
    const col=sets>=r?'var(--green)':sets>=r*.6?'var(--accent)':'var(--red)';
    html+=`<div class="muscle-row">
      <div class="muscle-name">${m}</div>
      <div class="muscle-bar-wrap"><div class="muscle-bar" style="width:${p}%;background:${col};box-shadow:0 0 8px ${col}40"></div></div>
      <div class="muscle-sets" style="color:${col}">${sets}</div>
    </div>`;
  }
  html+=`<div style="font-size:11px;color:var(--text-faint);margin-top:8px;font-family:var(--cond);letter-spacing:1px">Green = on track with recommended weekly volume.</div></div>`;
  html+=`<div class="card"><div class="card-title"><div class="accent-dot"></div>Sessions This Week</div>`;
  for (const s of [...thisWeek].reverse())
    html+=`<div class="exercise-item" style="cursor:default">
      <div style="flex:1">
        <div class="exercise-name">${s.day}${s.week?` <span class="tag tag-orange" style="font-size:9px">W${s.week}</span>`:''}</div>
        <div class="exercise-meta">${s.date} ¬∑ ${s.exercises.length} ex ¬∑ ${s.exercises.reduce((a,e)=>a+e.sets.length,0)} sets</div>
      </div></div>`;
  html+=`</div>`;
  el.innerHTML=html;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setProgramType(type) {
  state.program.type = type;
  document.getElementById('ptype-weekly').classList.toggle('selected', type==='weekly');
  document.getElementById('ptype-block').classList.toggle('selected',  type==='block');
  document.getElementById('block-length-row').style.display = type==='block' ? 'block' : 'none';
}

function saveSettings() {
  state.settings.restMultiplier = parseFloat(document.getElementById('setting-rest').value)||1.0;
  state.settings.dropPct        = parseInt(document.getElementById('setting-drop').value)||10;
  state.settings.increasePct    = parseInt(document.getElementById('setting-increase').value)||5;
  state.program.blockLength     = parseInt(document.getElementById('setting-block-length').value)||4;
  saveState(); updateWeekBadge();
}

document.getElementById('setting-rest').value         = state.settings.restMultiplier||1.0;
document.getElementById('setting-drop').value         = state.settings.dropPct;
document.getElementById('setting-increase').value     = state.settings.increasePct;
document.getElementById('setting-block-length').value = state.program.blockLength||4;
setProgramType(state.program.type||'weekly');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
updateWeekBadge();
renderToday();
renderPlan();
</script>
</body>
</html>
